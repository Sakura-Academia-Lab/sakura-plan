<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>è¨ˆç®—è„³ãƒ»ç²¾å¯†è¨ºæ–­ãƒ†ã‚¹ãƒˆ ï½å‡¦ç†ã®è³ªã¨å›è·¯ã®å¤ªã•ã‚’æ¸¬ã‚‹ï½</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kiwi+Maru:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div id="sidebar">
    <div class="sidebar-header">
        <h1>è¨ˆç®—è„³ãƒ»ç²¾å¯†è¨ºæ–­ãƒ†ã‚¹ãƒˆ</h1>
        <p>å‡¦ç†ã®è³ªã¨å›è·¯ã®å¤ªã•ã‚’æ¸¬ã‚‹</p>
    </div>
    <div id="menu-container"></div>
</div>

<div id="main-content">
    <div class="controls">
        <div class="tabs" id="pattern-tabs">
            <button class="tab active" onclick="setPattern(0)">ãƒ‘ã‚¿ãƒ¼ãƒ³A</button>
            <button class="tab" onclick="setPattern(1)">ãƒ‘ã‚¿ãƒ¼ãƒ³B</button>
            <button class="tab" onclick="setPattern(2)">ãƒ‘ã‚¿ãƒ¼ãƒ³C</button>
            <button class="tab" onclick="setPattern(3)">ãƒ‘ã‚¿ãƒ¼ãƒ³D</button>
            <button class="tab" onclick="setPattern(4)">ãƒ‘ã‚¿ãƒ¼ãƒ³E</button>
        </div>
        <div class="actions">
            <button class="btn-print" onclick="window.print()">å°åˆ·ç”¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’è¡¨ç¤º</button>
        </div>
    </div>
    <div id="sheet-area"></div>
</div>

<script>
    window.curriculumData = [];
    let activeUnitIdx = 0;
    let activePatternIdx = 0;
    let openChapters = new Set();
    let openSections = new Set();

    // annotationså†…ã®LaTeXè¨˜æ³•ã‚’\(ã¨\)ã§è‡ªå‹•çš„ã«å›²ã‚€
    function wrapAnnotationMath(text) {
        if (!text) return '';
        // æ—¥æœ¬èªãƒ»è¨˜å·ã§åŒºåˆ‡ã‚Šã€ãƒãƒƒã‚¯ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰ã‚’å«ã‚€éƒ¨åˆ†ã‚’æ•°å¼ã¨ã—ã¦å‡¦ç†
        const segments = text.split(/([\u4e00-\u9fff\u3040-\u309f\u30a0-\u30ff\u3000-\u303fâ˜…â˜†ãƒ»ã€‚ã€ã€Œã€ï¼ˆï¼‰ï¼ï¼Ÿ\s]+)/);
        return segments.map(seg => {
            if (seg.includes('\\') && /[a-z]/.test(seg)) {
                return `\\(${seg.trim()}\\)`;
            }
            return seg;
        }).join('');
    }

    function addData(unitData) {
        window.curriculumData.push(unitData);
        if(window.curriculumData.length === 1) {
            openChapters.add(unitData.chapter);
            if(unitData.section) openSections.add(unitData.chapter + '|' + unitData.section);
            renderMenu();
            renderSheet();
        } else {
            renderMenu();
        }
    }

    function formatLevelName(chapterName) {
        return chapterName.replace(/ç¬¬(\d+)ç« /, "ãƒ¬ãƒ™ãƒ«$1");
    }

    function formatSectionLabel(section) {
        // ã‚»ã‚¯ã‚·ãƒ§ãƒ³åã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ã«å¤‰æ›
        const labelMap = {
            'ã‚µãƒã‚¤ãƒãƒ«ãƒ†ã‚¹ãƒˆ': 'ğŸ”¥ ç·åˆåŠ›è¨ºæ–­ï¼ˆã‚µãƒã‚¤ãƒãƒ«ï¼‰â€»ã¾ãšã¯ã“ã‚Œï¼',
            'è¨“ç·´': 'ğŸ’ª å¼±ç‚¹å…‹æœãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚° â€»è¨ºæ–­ã§è½ã¡ãŸäººå‘ã‘'
        };
        return labelMap[section] || section;
    }

    function renderMenu() {
        const container = document.getElementById('menu-container');
        container.innerHTML = '';

        // Group units by chapter and section
        const hierarchy = {};
        window.curriculumData.forEach((unit, idx) => {
            const chapter = unit.chapter;
            const section = unit.section || 'æœªåˆ†é¡';
            if (!hierarchy[chapter]) hierarchy[chapter] = {};
            if (!hierarchy[chapter][section]) hierarchy[chapter][section] = [];
            hierarchy[chapter][section].push({ unit, idx });
        });

        // Render hierarchy
        Object.keys(hierarchy).forEach(chapter => {
            const isChapterOpen = openChapters.has(chapter);

            // Chapter header
            const chapterHeader = document.createElement('div');
            chapterHeader.className = 'nav-group-header';
            chapterHeader.innerHTML = `
                <span>${formatLevelName(chapter)}</span>
                <span class="toggle-icon">${isChapterOpen ? 'â–¼' : 'â–¶'}</span>
            `;
            chapterHeader.onclick = () => {
                if(openChapters.has(chapter)) {
                    openChapters.delete(chapter);
                } else {
                    openChapters.add(chapter);
                }
                renderMenu();
            };
            container.appendChild(chapterHeader);

            if (!isChapterOpen) return;

            // Chapter wrapper
            const chapterWrapper = document.createElement('div');
            chapterWrapper.className = 'nav-level-wrapper';
            container.appendChild(chapterWrapper);

            // Sections within chapter
            Object.keys(hierarchy[chapter]).forEach(section => {
                const sectionKey = chapter + '|' + section;
                const isSectionOpen = openSections.has(sectionKey);

                // Section header
                const sectionHeader = document.createElement('div');
                sectionHeader.className = 'nav-section-header';
                sectionHeader.innerHTML = `
                    <span>${formatSectionLabel(section)}</span>
                    <span class="toggle-icon">${isSectionOpen ? 'â–¼' : 'â–¶'}</span>
                `;
                sectionHeader.onclick = (e) => {
                    e.stopPropagation();
                    if(openSections.has(sectionKey)) {
                        openSections.delete(sectionKey);
                    } else {
                        openSections.add(sectionKey);
                    }
                    renderMenu();
                };
                chapterWrapper.appendChild(sectionHeader);

                if (!isSectionOpen) return;

                // Units within section
                hierarchy[chapter][section].forEach(({ unit, idx }) => {
                    const unitItem = document.createElement('div');
                    unitItem.className = `nav-item ${idx === activeUnitIdx ? 'active' : ''}`;
                    unitItem.innerText = unit.title;
                    unitItem.onclick = (e) => {
                        e.stopPropagation();
                        activeUnitIdx = idx;
                        renderMenu();
                        renderSheet();
                    };
                    chapterWrapper.appendChild(unitItem);
                });
            });
        });
    }

    function setPattern(idx) {
        const unit = window.curriculumData[activeUnitIdx];
        if (!unit || idx >= unit.patterns.length) return;
        activePatternIdx = idx;
        document.querySelectorAll('.tab').forEach((t, i) => t.classList.toggle('active', i === idx));
        renderSheet();
    }

    function renderSheet() {
        if (window.curriculumData.length === 0) return;
        const unit = window.curriculumData[activeUnitIdx];

        // ãƒ‘ã‚¿ãƒ¼ãƒ³æ•°ãƒã‚§ãƒƒã‚¯ãƒ»èª¿æ•´
        if (activePatternIdx >= unit.patterns.length) activePatternIdx = 0;
        const pattern = unit.patterns[activePatternIdx];

        // ã‚¿ãƒ–ãƒ©ãƒ™ãƒ«æ›´æ–°ï¼ˆå‹•çš„ï¼‰
        const patternLabels = unit.patternLabels || ['ãƒ‘ã‚¿ãƒ¼ãƒ³A', 'ãƒ‘ã‚¿ãƒ¼ãƒ³B', 'ãƒ‘ã‚¿ãƒ¼ãƒ³C', 'ãƒ‘ã‚¿ãƒ¼ãƒ³D', 'ãƒ‘ã‚¿ãƒ¼ãƒ³E'];
        document.querySelectorAll('.tab').forEach((t, i) => {
            if (i < unit.patterns.length) {
                t.style.display = '';
                t.textContent = patternLabels[i] || `ãƒ‘ã‚¿ãƒ¼ãƒ³${String.fromCharCode(65 + i)}`;
            } else {
                t.style.display = 'none';
            }
        });

        const area = document.getElementById('sheet-area');
        const label = patternLabels[activePatternIdx] || String.fromCharCode(65 + activePatternIdx);

        // ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«ã‚’å‹•çš„ã«æ›´æ–°ï¼ˆPDFåã«åæ˜ ï¼‰
        const pageTitle = `${formatLevelName(unit.chapter)} ${unit.title} ã€${label}ã€‘`;
        document.title = pageTitle;

        // å•é¡Œæ•°ã«å¿œã˜ãŸãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆé¸æŠ
        let layoutClass = '';
        if (pattern.problems.length >= 20) {
            layoutClass = 'survival-sheet'; // 30å•æƒ³å®šï¼š2åˆ—
        } else if (pattern.problems.length <= 2) {
            layoutClass = 'ultra-few'; // ãƒ¬ãƒ™ãƒ«5ç”¨ï¼š110mmä½™ç™½
        } else if (pattern.problems.length <= 5) {
            layoutClass = 'few-problems'; // æš—ç®—Bãªã©ï¼š90pxä½™ç™½
        }

        // ç¾åœ¨ã®æ—¥ä»˜ã‚’å–å¾—ï¼ˆå°åˆ·æ—¥ã¨ã—ã¦ä½¿ç”¨ï¼‰
        const today = new Date();
        const printDate = `${today.getFullYear()}/${today.getMonth()+1}/${today.getDate()}`;

        area.innerHTML = `
            <div class="page page-break ${layoutClass}">
                <div class="header">
                    <div class="title-area">
                        <span class="chapter-label">${formatLevelName(unit.chapter)}</span>
                        <div class="main-title">${unit.title}<span class="pattern-label">ã€${label}ã€‘</span></div>
                    </div>
                    <div class="info-box">
                        <div class="info-item date-item print-date">${printDate}</div>
                        <div class="info-item name-item">åå‰</div>
                    </div>
                </div>
                <div class="method-box">ç›®æ¨™ï¼š${unit.method}</div>
                <ul class="problems">
                    ${pattern.problems.map((p, i) => `
                        <li class="problem-item">
                            <span class="p-num">(${i+1})</span>
                            <div class="p-content">\\(${p}\\)</div>
                            <div class="answer-box-empty"></div>
                        </li>
                    `).join('')}
                </ul>
            </div>

            <div class="page ${layoutClass}">
                <div class="header color-exp">
                    <div class="title-area">
                        <span class="chapter-label">è§£ç­”ã¨æŒ‡å°ãƒã‚¤ãƒ³ãƒˆ</span>
                        <div class="main-title">${unit.title} <span class="pattern-label">ã€${label}ã€‘è§£èª¬</span></div>
                    </div>
                </div>
                <div class="explanation-container">
                    ${pattern.problems.map((p, i) => `
                        <div class="exp-unit">
                            <div class="exp-top">
                                <span class="p-num">(${i+1})</span>
                                <div class="p-content">\\(${p}\\)</div>
                                <div class="ans-box-filled">
                                    <span class="ans-text">${pattern.answers[i]}</span>
                                </div>
                            </div>
                            ${layoutClass !== 'survival-sheet' ? `
                            <div class="exp-annotation">
                                ${pattern.annotations[i] ? `<span class="handwritten-note">${wrapAnnotationMath(pattern.annotations[i])}</span>` : ''}
                            </div>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
        if (window.MathJax) MathJax.typeset(); 
    }
</script>

<script src="sec1_survival.js"></script>
<script src="sec2_survival.js"></script>
<script src="sec3_survival.js"></script>
<script src="sec1a_decimal_fraction.js"></script>
<script src="sec1b_squares.js"></script>
<script src="sec1c_pi.js"></script>
<script src="sec1d_primes.js"></script>
<script src="sec1e_golden_pairs.js"></script>
<script src="sec1f_complements.js"></script>
<script src="sec1g_mental_math.js"></script>
<script src="sec2_structure.js"></script>
<script src="sec2b_gcd.js"></script>
<script src="sec3_endurance.js"></script>
<script src="sec3_audit.js"></script>

</body>
</html>