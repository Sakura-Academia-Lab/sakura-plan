<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>計算脳・精密診断テスト ～処理の質と回路の太さを測る～</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kiwi+Maru:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div id="sidebar">
    <div class="sidebar-header">
        <h1>計算脳・精密診断テスト</h1>
        <p>処理の質と回路の太さを測る</p>
    </div>
    <div id="menu-container"></div>
</div>

<div id="main-content">
    <div class="controls">
        <div class="tabs" id="pattern-tabs">
            <button class="tab active" onclick="setPattern(0)">パターンA</button>
            <button class="tab" onclick="setPattern(1)">パターンB</button>
            <button class="tab" onclick="setPattern(2)">パターンC</button>
            <button class="tab" onclick="setPattern(3)">パターンD</button>
            <button class="tab" onclick="setPattern(4)">パターンE</button>
        </div>
        <div class="actions">
            <button class="btn-print" onclick="window.print()">印刷用レイアウトを表示</button>
        </div>
    </div>
    <div id="sheet-area"></div>
</div>

<script>
    window.curriculumData = [];
    let activeUnitIdx = 0;
    let activePatternIdx = 0;
    let openChapters = new Set();
    let openSections = new Set();

    // annotations内のLaTeX記法を\(と\)で自動的に囲む
    function wrapAnnotationMath(text) {
        if (!text) return '';
        // 日本語・記号で区切り、バックスラッシュコマンドを含む部分を数式として処理
        const segments = text.split(/([\u4e00-\u9fff\u3040-\u309f\u30a0-\u30ff\u3000-\u303f★☆・。、「」（）！？\s]+)/);
        return segments.map(seg => {
            if (seg.includes('\\') && /[a-z]/.test(seg)) {
                return `\\(${seg.trim()}\\)`;
            }
            return seg;
        }).join('');
    }

    function addData(unitData) {
        window.curriculumData.push(unitData);
        if(window.curriculumData.length === 1) {
            openChapters.add(unitData.chapter);
            if(unitData.section) openSections.add(unitData.chapter + '|' + unitData.section);
            renderMenu();
            renderSheet();
        } else {
            renderMenu();
        }
    }

    function formatLevelName(chapterName) {
        return chapterName.replace(/第(\d+)章/, "レベル$1");
    }

    function renderMenu() {
        const container = document.getElementById('menu-container');
        container.innerHTML = '';

        // Group units by chapter and section
        const hierarchy = {};
        window.curriculumData.forEach((unit, idx) => {
            const chapter = unit.chapter;
            const section = unit.section || '未分類';
            if (!hierarchy[chapter]) hierarchy[chapter] = {};
            if (!hierarchy[chapter][section]) hierarchy[chapter][section] = [];
            hierarchy[chapter][section].push({ unit, idx });
        });

        // Render hierarchy
        Object.keys(hierarchy).forEach(chapter => {
            const isChapterOpen = openChapters.has(chapter);

            // Chapter header
            const chapterHeader = document.createElement('div');
            chapterHeader.className = 'nav-group-header';
            chapterHeader.innerHTML = `
                <span>${formatLevelName(chapter)}</span>
                <span class="toggle-icon">${isChapterOpen ? '▼' : '▶'}</span>
            `;
            chapterHeader.onclick = () => {
                if(openChapters.has(chapter)) {
                    openChapters.delete(chapter);
                } else {
                    openChapters.add(chapter);
                }
                renderMenu();
            };
            container.appendChild(chapterHeader);

            if (!isChapterOpen) return;

            // Chapter wrapper
            const chapterWrapper = document.createElement('div');
            chapterWrapper.className = 'nav-level-wrapper';
            container.appendChild(chapterWrapper);

            // Sections within chapter
            Object.keys(hierarchy[chapter]).forEach(section => {
                const sectionKey = chapter + '|' + section;
                const isSectionOpen = openSections.has(sectionKey);

                // Section header
                const sectionHeader = document.createElement('div');
                sectionHeader.className = 'nav-section-header';
                sectionHeader.innerHTML = `
                    <span>${section}</span>
                    <span class="toggle-icon">${isSectionOpen ? '▼' : '▶'}</span>
                `;
                sectionHeader.onclick = (e) => {
                    e.stopPropagation();
                    if(openSections.has(sectionKey)) {
                        openSections.delete(sectionKey);
                    } else {
                        openSections.add(sectionKey);
                    }
                    renderMenu();
                };
                chapterWrapper.appendChild(sectionHeader);

                if (!isSectionOpen) return;

                // Units within section
                hierarchy[chapter][section].forEach(({ unit, idx }) => {
                    const unitItem = document.createElement('div');
                    unitItem.className = `nav-item ${idx === activeUnitIdx ? 'active' : ''}`;
                    unitItem.innerText = unit.title;
                    unitItem.onclick = (e) => {
                        e.stopPropagation();
                        activeUnitIdx = idx;
                        renderMenu();
                        renderSheet();
                    };
                    chapterWrapper.appendChild(unitItem);
                });
            });
        });
    }

    function setPattern(idx) {
        const unit = window.curriculumData[activeUnitIdx];
        if (!unit || idx >= unit.patterns.length) return;
        activePatternIdx = idx;
        document.querySelectorAll('.tab').forEach((t, i) => t.classList.toggle('active', i === idx));
        renderSheet();
    }

    function renderSheet() {
        if (window.curriculumData.length === 0) return;
        const unit = window.curriculumData[activeUnitIdx];

        // パターン数チェック・調整
        if (activePatternIdx >= unit.patterns.length) activePatternIdx = 0;
        const pattern = unit.patterns[activePatternIdx];

        // タブラベル更新（動的）
        const patternLabels = unit.patternLabels || ['パターンA', 'パターンB', 'パターンC', 'パターンD', 'パターンE'];
        document.querySelectorAll('.tab').forEach((t, i) => {
            if (i < unit.patterns.length) {
                t.style.display = '';
                t.textContent = patternLabels[i] || `パターン${String.fromCharCode(65 + i)}`;
            } else {
                t.style.display = 'none';
            }
        });

        const area = document.getElementById('sheet-area');
        const label = patternLabels[activePatternIdx] || String.fromCharCode(65 + activePatternIdx);

        // 問題数に応じたレイアウト選択
        let layoutClass = '';
        if (pattern.problems.length >= 20) {
            layoutClass = 'survival-sheet'; // 30問想定：2列
        } else if (pattern.problems.length <= 2) {
            layoutClass = 'ultra-few'; // レベル5用：110mm余白
        } else if (pattern.problems.length <= 5) {
            layoutClass = 'few-problems'; // 暗算Bなど：90px余白
        }

        area.innerHTML = `
            <div class="page page-break ${layoutClass}">
                <div class="header">
                    <div class="title-area">
                        <span class="chapter-label">${formatLevelName(unit.chapter)}</span>
                        <div class="main-title">${unit.title} <span class="pattern-label">【${label}】</span></div>
                    </div>
                    <div class="info-box">
                        <div class="info-item date-item">月　日</div>
                        <div class="info-item name-item">名前</div>
                    </div>
                </div>
                <div class="method-box">目標：${unit.method}</div>
                <ul class="problems">
                    ${pattern.problems.map((p, i) => `
                        <li class="problem-item">
                            <span class="p-num">(${i+1})</span>
                            <div class="p-content">\\(${p}\\)</div>
                            <div class="answer-box-empty"></div>
                        </li>
                    `).join('')}
                </ul>
            </div>

            <div class="page ${layoutClass}">
                <div class="header color-exp">
                    <div class="title-area">
                        <span class="chapter-label">解答と指導ポイント</span>
                        <div class="main-title">${unit.title} <span class="pattern-label">【${label}】解説</span></div>
                    </div>
                </div>
                <div class="explanation-container">
                    ${pattern.problems.map((p, i) => `
                        <div class="exp-unit">
                            <div class="exp-top">
                                <span class="p-num">(${i+1})</span>
                                <div class="p-content">\\(${p}\\)</div>
                                <div class="ans-box-filled">
                                    <span class="ans-text">${pattern.answers[i]}</span>
                                </div>
                            </div>
                            ${layoutClass !== 'survival-sheet' ? `
                            <div class="exp-annotation">
                                ${pattern.annotations[i] ? `<span class="handwritten-note">${wrapAnnotationMath(pattern.annotations[i])}</span>` : ''}
                            </div>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
        if (window.MathJax) MathJax.typeset(); 
    }
</script>

<script src="sec1_survival.js"></script>
<script src="sec2_survival.js"></script>
<script src="sec3_survival.js"></script>
<script src="sec1_reflexes.js"></script>
<script src="sec1b_factors.js"></script>
<script src="sec2_structure.js"></script>
<script src="sec2b_gcd.js"></script>
<script src="sec3_endurance.js"></script>
<script src="sec3_audit.js"></script>

</body>
</html>