<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¼¢å­—ãƒ»ãµã‚ŠãŒãªãƒã‚§ãƒƒã‚«ãƒ¼ - æ¡œã‚¢ã‚«ãƒ‡ãƒŸã‚¢</title>
    <style>
        body {
            font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
            background-color: #f0f4f8;
            color: #333;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 950px;
            margin: 0 auto;
            background: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 24px;
        }

        .version-badge {
            text-align: center;
            margin-bottom: 25px;
        }

        .version-badge span {
            display: inline-block;
            background-color: #d1e7dd;
            color: #0f5132;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: bold;
            border: 1px solid #badbcc;
        }

        /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚¨ãƒªã‚¢ */
        .controls {
            background: #eaf2f8;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 25px;
            border: 1px solid #d6eaf8;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 15px 30px;
        }

        .control-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-row.full-width {
            grid-column: 1 / -1;
        }

        .control-label {
            font-weight: bold;
            font-size: 14px;
            color: #34495e;
            min-width: 85px;
            display: inline-block;
        }

        select {
            padding: 8px;
            font-size: 15px;
            border-radius: 4px;
            border: 1px solid #ccc;
            flex-grow: 1;
            max-width: 250px;
        }

        .radio-group,
        .checkbox-group {
            display: flex;
            gap: 15px;
            align-items: center;
            background: #fff;
            padding: 8px 15px;
            border-radius: 4px;
            border: 1px solid #ddd;
            flex-grow: 1;
        }

        .radio-group label,
        .checkbox-group label {
            font-weight: normal;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            margin: 0;
            font-size: 14px;
        }

        /* æƒ…å ±è¡¨ç¤ºã‚¨ãƒªã‚¢ */
        .mojibake-info-container {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .info-section {
            background-color: #fcfdfe;
            border: 1px solid #d6eaf8;
            border-radius: 6px;
            padding: 15px;
            font-size: 12px;
        }

        .info-section b {
            display: block;
            margin-bottom: 10px;
            padding-bottom: 5px;
            font-size: 13px;
        }

        .section-auto {
            border-left: 4px solid #3498db;
        }

        .section-auto b {
            color: #2980b9;
            border-bottom: 1px solid #d6eaf8;
        }

        .section-proof {
            border-left: 4px solid #e67e22;
        }

        .section-proof b {
            color: #d35400;
            border-bottom: 1px solid #fadbd8;
        }

        .mojibake-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .mojibake-item {
            background: #fff;
            padding: 4px 10px;
            border-radius: 4px;
            border: 1px solid #deeef9;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.03);
        }

        .mojibake-item strong {
            color: #c0392b;
        }

        textarea {
            width: 100%;
            height: 180px;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
            margin-bottom: 15px;
            font-family: inherit;
        }

        .btn-main {
            width: 100%;
            padding: 15px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 18px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
            box-shadow: 0 4px 0 #2980b9;
            margin-bottom: 10px;
        }

        .btn-main:hover {
            background-color: #2980b9;
            box-shadow: 0 2px 0 #2980b9;
            transform: translateY(2px);
        }

        .btn-sub {
            width: 100%;
            padding: 10px;
            background-color: #95a5a5;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.3s;
            margin-bottom: 20px;
        }

        #kanjiReference {
            display: none;
            margin-top: 10px;
            padding: 20px;
            background: #f9f9f9;
            border: 1px dashed #ccc;
            border-radius: 6px;
        }

        .grade-block {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .grade-title {
            font-weight: bold;
            color: #2c3e50;
            font-size: 15px;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
        }

        .grade-count {
            background: #34495e;
            color: #fff;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
        }

        .kanji-list {
            font-size: 14px;
            word-break: break-all;
            letter-spacing: 2px;
            color: #555;
        }

        #outputArea {
            margin-top: 30px;
            padding: 30px;
            border: 2px solid #eee;
            border-radius: 4px;
            background-color: #fff;
            font-size: 18px;
            line-height: 4.0;
            min-height: 100px;
        }

        /* å…±é€šè­¦å‘ŠåŸºæº– */
        .kanji-target,
        .typo-alert {
            font-weight: bold;
            border-radius: 2px;
            padding: 0 2px;
            position: relative;
        }

        /* æ¼¢å­—è‰²åˆ†ã‘ */
        .mode-split .kanji-first {
            color: #d63031;
            background-color: #fff5f5;
        }

        .mode-split .kanji-repeat {
            color: #006400;
            background-color: #ccff90;
        }

        .mode-allred .kanji-first,
        .mode-allred .kanji-repeat {
            color: #d63031;
            font-weight: bold;
            background-color: #fff5f5;
        }

        /* æ ¡æ­£æ³¨æ„ç”¨ã‚¹ã‚¿ã‚¤ãƒ« [UPDATE] */
        .typo-alert {
            background-color: #fff3cd;
            color: #856404;
            border-bottom: 4px solid #e67e22 !important;
        }

        .typo-alert::after {
            content: attr(data-hint);
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: #d35400;
            font-weight: bold;
            white-space: nowrap;
            line-height: 1;
            pointer-events: none;
            padding-top: 5px;
            z-index: 10;
        }

        /* æ¼¢å­—è­¦å‘Š */
        .warning-missing-furigana,
        .warning-extra-furigana,
        .warning-check-furigana {
            border-bottom: 4px solid #ff0000 !important;
            background-color: transparent !important;
        }

        .warning-missing-furigana::after,
        .warning-extra-furigana::after,
        .warning-check-furigana::after {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: #ff0000;
            font-weight: bold;
            white-space: nowrap;
            line-height: 1;
            pointer-events: none;
            padding-top: 5px;
        }

        .warning-missing-furigana::after {
            content: "ãµã‚ŠãŒãªå¿…è¦ï¼";
        }

        .warning-extra-furigana::after {
            content: "ãµã‚ŠãŒãªä¸è¦ï¼";
        }

        .warning-check-furigana::after {
            content: "ãƒ«ãƒ“é•ã„ï¼Ÿ";
        }

        .legend {
            margin-top: 10px;
            font-size: 13px;
            color: #555;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: flex-end;
        }

        .badge {
            padding: 3px 8px;
            border-radius: 3px;
            font-weight: bold;
            border: 1px solid #ccc;
            font-size: 11px;
            display: inline-block;
        }

        .badge-warn {
            border-bottom: 3px solid red;
            color: black;
            font-weight: bold;
        }

        .badge-typo {
            background-color: #fff3cd;
            color: #856404;
            border-bottom: 2px solid #e67e22;
        }

        @media (max-width: 800px) {
            .mojibake-info-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>

    <div class="container">
        <h1>æ¼¢å­—ãƒ»ãµã‚ŠãŒãªãƒã‚§ãƒƒã‚«ãƒ¼ <small>ver5.5</small></h1>

        <div class="version-badge">
            <span>âœ… å¹³æˆ29å¹´å‘Šç¤º (ä»¤å’Œ2å¹´åº¦ã€œå®Ÿæ–½) å¯¾å¿œ ï¼ å…¨1026æ–‡å­—</span>
        </div>

        <div class="controls">
            <div class="control-row">
                <span class="control-label">ä½œæˆå­¦å¹´:</span>
                <select id="gradeSelect">
                    <option value="1">1å¹´ç”Ÿ / æ–°2å¹´ç”Ÿ</option>
                    <option value="2">2å¹´ç”Ÿ / æ–°3å¹´ç”Ÿ</option>
                    <option value="3" selected>3å¹´ç”Ÿ / æ–°4å¹´ç”Ÿ</option>
                    <option value="4">4å¹´ç”Ÿ / æ–°5å¹´ç”Ÿ</option>
                    <option value="5">5å¹´ç”Ÿ / æ–°6å¹´ç”Ÿ</option>
                    <option value="6">6å¹´ç”Ÿ</option>
                </select>
            </div>
            <div class="control-row">
                <span class="control-label">ç°¡æ˜“æ ¡æ­£:</span>
                <div class="checkbox-group">
                    <label><input type="checkbox" id="proofreadMode"> æ ¡æ­£ãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹ã«ã™ã‚‹</label>
                </div>
            </div>
            <div class="control-row">
                <span class="control-label">è²¼ã‚Šä»˜ã‘å…ƒ:</span>
                <div class="radio-group">
                    <label><input type="radio" name="sourceMode" value="ichitaro" checked> ä¸€å¤ªéƒ (è­¦å‘Šã‚ã‚Š)</label>
                    <label><input type="radio" name="sourceMode" value="pdf"> PDF (è­¦å‘Šãªã—)</label>
                </div>
            </div>
            <div class="control-row">
                <span class="control-label">è‰²åˆ†ã‘:</span>
                <div class="radio-group">
                    <label><input type="radio" name="colorMode" value="split" checked> åˆå›:èµ¤ / 2å›ç›®:é»„ç·‘</label>
                    <label><input type="radio" name="colorMode" value="allred"> ã™ã¹ã¦èµ¤å­—</label>
                </div>
            </div>
            <div class="control-row full-width">
                <span class="control-label">æ•´å½¢:</span>
                <div class="checkbox-group">
                    <label><input type="checkbox" id="formatText" checked> æ”¹è¡Œã‚’è‡ªå‹•ã§æ•´ãˆã‚‹ï¼ˆç®—æ•°ãƒ—ãƒªãƒ³ãƒˆè²¼ã‚Šä»˜ã‘æ™‚ã«æ¨å¥¨ï¼‰</label>
                </div>
            </div>
            <div class="mojibake-info-container">
                <div class="info-section section-auto">
                    <b>ğŸ”„ è‡ªå‹•çš„ã«è¡Œã‚ã‚Œã‚‹æ–‡å­—ä¿®å¾©</b>
                    <div class="mojibake-list">
                        <div class="mojibake-item">æˆ–ã™ã¹ã¦ â†’ <strong>ã </strong></div>
                        <div class="mojibake-item">æ•°å­—ï¼‹å®‰ãƒ»(å®‰) â†’ <strong>ã¤</strong></div>
                        <div class="mojibake-item">å”„ã€œå™‚ â†’ <strong>(1)ã€œ(10)</strong></div>
                    </div>
                </div>
                <div class="info-section section-proof">
                    <b>ğŸ“ ç°¡æ˜“æ ¡é–²ãƒ«ãƒ¼ãƒ« (æ ¡æ­£ONæ™‚)</b>
                    <div class="mojibake-list">
                        <div class="mojibake-item">1æ¡æ•°å­—ï¼š<strong>å…¨è§’æ¨å¥¨</strong></div>
                        <div class="mojibake-item">2æ¡ä»¥ä¸Šï¼š<strong>åŠè§’æ¨å¥¨</strong></div>
                        <div class="mojibake-item">èª­ç‚¹ã€Œã€ã€ â†’ <strong>ã€Œï¼Œã€</strong></div>
                    </div>
                </div>
            </div>
        </div>

        <textarea id="inputText" placeholder="æ–‡ç« ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚"></textarea>
        <button class="btn-main" onclick="analyzeText()">ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ</button>
        <button class="btn-sub" onclick="toggleKanjiList()" id="toggleBtn">â–¼ å„å­¦å¹´ã®é…å½“æ¼¢å­—ä¸€è¦§ã‚’è¡¨ç¤ºã™ã‚‹</button>
        <div id="kanjiReference"></div>
        <div class="legend">
            <span><span class="badge" style="background:#fff5f5; color:#d63031; border-color:#d63031;">èµ¤</span>
                åˆå›</span>
            <span><span class="badge" style="background:#ccff90; color:#006400; border-color:#ccff90;">é»„ç·‘</span>
                æ—¢å‡º</span>
            <span><span class="badge-typo badge">æ©™ä¸‹ç·š</span> æ ¡æ­£æ³¨æ„</span>
            <span><span class="badge badge-warn">èµ¤ä¸‹ç·š</span> è­¦å‘Š</span>
        </div>
        <div id="outputArea" class="mode-split"></div>
    </div>

    <script>
        const kanjiDb = {
            1: "ä¸€å³é›¨å††ç‹éŸ³ä¸‹ç«èŠ±è²å­¦æ°—ä¹ä¼‘ç‰é‡‘ç©ºæœˆçŠ¬è¦‹äº”å£æ ¡å·¦ä¸‰å±±å­å››ç³¸å­—è€³ä¸ƒè»Šæ‰‹åå‡ºå¥³å°ä¸Šæ£®äººæ°´æ­£ç”Ÿé’å¤•çŸ³èµ¤åƒå·å…ˆæ—©è‰è¶³æ‘å¤§ç”·ç«¹ä¸­è™«ç”ºå¤©ç”°åœŸäºŒæ—¥å…¥å¹´ç™½å…«ç™¾æ–‡æœ¨æœ¬åç›®ç«‹åŠ›æ—å…­",
            2: "å¼•ç¾½é›²åœ’é ä½•ç§‘å¤å®¶æ­Œç”»å›ä¼šæµ·çµµå¤–è§’æ¥½æ´»é–“ä¸¸å²©é¡”æ±½è¨˜å¸°å¼“ç‰›é­šäº¬å¼·æ•™è¿‘å…„å½¢è¨ˆå…ƒè¨€åŸæˆ¸å¤åˆå¾Œèªå·¥å…¬åºƒäº¤å…‰è€ƒè¡Œé«˜é»„åˆè°·å›½é»’ä»Šæ‰ç´°ä½œç®—æ­¢å¸‚çŸ¢å§‰æ€ç´™å¯ºè‡ªæ™‚å®¤ç¤¾å¼±é¦–ç§‹é€±æ˜¥æ›¸å°‘å ´è‰²é£Ÿå¿ƒæ–°è¦ªå›³æ•°è¥¿å£°æ˜Ÿæ™´åˆ‡é›ªèˆ¹ç·šå‰çµ„èµ°å¤šå¤ªä½“å°åœ°æ± çŸ¥èŒ¶æ˜¼é•·é³¥æœç›´é€šå¼Ÿåº—ç‚¹é›»åˆ€å†¬å½“æ±ç­”é ­åŒé“èª­å†…å—è‚‰é¦¬å£²è²·éº¦åŠç•ªçˆ¶é¢¨åˆ†èç±³æ­©æ¯æ–¹åŒ—æ¯å¦¹ä¸‡æ˜é³´æ¯›é–€å¤œé‡å‹ç”¨æ›œæ¥é‡Œç†è©±",
            3: "æ‚ªå®‰æš—åŒ»å§”æ„è‚²å“¡é™¢é£²é‹æ³³é§…å¤®æ¨ªå±‹æ¸©åŒ–è·ç•Œé–‹éšå¯’æ„Ÿæ¼¢é¤¨å²¸èµ·æœŸå®¢ç©¶æ€¥ç´šå®®çƒå»æ©‹æ¥­æ›²å±€éŠ€åŒºè‹¦å…·å›ä¿‚è»½è¡€æ±ºç ”çœŒåº«æ¹–å‘å¹¸æ¸¯å·æ ¹ç¥­çš¿ä»•æ­»ä½¿å§‹æŒ‡æ­¯è©©æ¬¡äº‹æŒå¼å®Ÿå†™è€…ä¸»å®ˆå–é…’å—å·æ‹¾çµ‚ç¿’é›†ä½é‡å®¿æ‰€æš‘åŠ©æ˜­æ¶ˆå•†ç« å‹ä¹—æ¤ç”³èº«ç¥çœŸæ·±é€²ä¸–æ•´æ˜”å…¨ç›¸é€æƒ³æ¯é€Ÿæ—ä»–æ‰“å¯¾å¾…ä»£ç¬¬é¡Œç‚­çŸ­è«‡ç€æ³¨æŸ±ä¸å¸³èª¿è¿½å®šåº­ç¬›é‰„è»¢éƒ½åº¦æŠ•è±†å³¶æ¹¯ç™»ç­‰å‹•ç«¥è¾²æ³¢é…å€ç®±ç•‘ç™ºåå‚æ¿çš®æ‚²ç¾é¼»ç­†æ°·è¡¨ç§’ç—…å“è² éƒ¨æœç¦ç‰©å¹³è¿”å‹‰æ”¾å‘³å‘½é¢å•å½¹è–¬ç”±æ²¹æœ‰éŠäºˆç¾Šæ´‹è‘‰é™½æ§˜è½æµæ—…ä¸¡ç·‘ç¤¼åˆ—ç·´è·¯å’Œ",
            4: "æ„›æ¡ˆä»¥è¡£ä½èŒ¨å°è‹±æ „åª›å¡©å²¡å„„åŠ æœè²¨èª²èŠ½è³€æ”¹æ¢°å®³è¡—å„è¦šæ½Ÿå®Œå®˜ç®¡é–¢è¦³é¡˜å²å¸Œå­£æ——å™¨æ©Ÿè­°æ±‚æ³£çµ¦æŒ™æ¼å…±å”é¡ç«¶æ¥µç†Šè¨“è»éƒ¡ç¾¤å¾„æ™¯èŠ¸æ¬ çµå»ºå¥é¨“å›ºåŠŸå¥½é¦™å€™åº·ä½å·®èœæœ€åŸ¼æå´æ˜¨æœ­åˆ·å¯Ÿå‚ç”£æ•£æ®‹æ°å¸è©¦å…æ²»æ»‹è¾é¹¿å¤±å€Ÿç¨®å‘¨ç¥é †åˆæ¾ç¬‘å”±ç„¼ç…§åŸç¸„è‡£ä¿¡äº•æˆçœæ¸…é™å¸­ç©æŠ˜ç¯€èª¬æµ…æˆ¦é¸ç„¶äº‰å€‰å·£æŸå´ç¶šå’å­«å¸¯éšŠé”å˜ç½®ä»²æ²–å…†ä½åº•çš„å…¸ä¼å¾’åŠªç¯åƒç‰¹å¾³æ ƒå¥ˆæ¢¨ç†±å¿µæ•—æ¢…åšé˜ªé£¯é£›å¿…ç¥¨æ¨™ä¸å¤«ä»˜åºœé˜œå¯Œå‰¯å…µåˆ¥è¾ºå¤‰ä¾¿åŒ…æ³•æœ›ç‰§æœ«æº€æœªæ°‘ç„¡ç´„å‹‡è¦é¤Šæµ´åˆ©é™¸è‰¯æ–™é‡è¼ªé¡ä»¤å†·ä¾‹é€£è€åŠ´éŒ²",
            5: "åœ§å›²ç§»å› æ°¸å–¶è¡›æ˜“ç›Šæ¶²æ¼”å¿œå¾€æ¡œå¯ä»®ä¾¡æ²³éå¿«è§£æ ¼ç¢ºé¡åˆŠå¹¹æ…£çœ¼ç´€åŸºå¯„è¦å–œæŠ€ç¾©é€†ä¹…æ—§æ•‘å±…è¨±å¢ƒå‡ç¦å¥å‹çµŒæ½”ä»¶éšªæ¤œé™ç¾æ¸›æ•…å€‹è­·åŠ¹åšè€•èˆªé‰±æ§‹èˆˆè¬›å‘Šæ··æŸ»å†ç½å¦»æ¡éš›åœ¨è²¡ç½ªæ®ºé›‘é…¸è³›å£«æ”¯å²å¿—æå¸«è³‡é£¼ç¤ºä¼¼è­˜è³ªèˆè¬æˆä¿®è¿°è¡“æº–åºæ‹›è¨¼è±¡è³æ¡çŠ¶å¸¸æƒ…ç¹”è·åˆ¶æ€§æ”¿å‹¢ç²¾è£½ç¨è²¬ç¸¾æ¥è¨­çµ¶ç¥–ç´ ç·é€ åƒå¢—å‰‡æ¸¬å±ç‡æè²¸æ…‹å›£æ–­ç¯‰è²¯å¼µåœæç¨‹é©çµ±å ‚éŠ…å°å¾—æ¯’ç‹¬ä»»ç‡ƒèƒ½ç ´çŠ¯åˆ¤ç‰ˆæ¯”è‚¥éè²»å‚™è©•è²§å¸ƒå©¦æ­¦å¾©è¤‡ä»ç²‰ç·¨å¼ä¿å¢“å ±è±Šé˜²è²¿æš´è„ˆå‹™å¤¢è¿·ç¶¿è¼¸ä½™å®¹ç•¥ç•™é ˜æ­´",
            6: "èƒƒç•°éºåŸŸå®‡æ˜ å»¶æ²¿æ©æˆ‘ç°æ‹¡é©é–£å‰²æ ªå¹²å·»çœ‹é›£ç°¡å±æœºæ®è²´ç–‘å¸ä¾›èƒ¸éƒ·å‹¤ç­‹ç³»æ•¬è­¦åŠ‡æ¿€ç©´åˆ¸çµ¹æ¨©æ†²æºå³å·±å‘¼èª¤åå­çš‡ç´…é™é‹¼åˆ»ç©€éª¨å›°ç ‚åº§æ¸ˆè£ç­–å†Šèš•è‡³ç§å§¿è¦–è©èªŒç£å°„æ¨å°ºè‹¥æ¨¹åå®—å°±è¡†å¾“ç¸¦ç¸®ç†Ÿç´”å‡¦ç½²è«¸é™¤æ‰¿å°†å‚·éšœè’¸é‡ä»å‚æ¨å¯¸ç››è–èª èˆŒå®£å°‚æ³‰æ´—æŸ“éŠ­å–„å¥çª“å‰µè£…å±¤æ“è”µè‡“å­˜å°Šé€€å®…æ‹…æ¢èª•æ®µæš–å€¤å®™å¿ è‘—åºé ‚è…¸æ½®è³ƒç—›æ•µå±•è¨å…šç³–å±Šé›£ä¹³èªç´è„³æ´¾æ‹èƒŒè‚ºä¿³ç­æ™©å¦æ‰¹ç§˜ä¿µè…¹å¥®ä¸¦é™›é–‰ç‰‡è£œæš®å®è¨ªäº¡å¿˜æ£’æšå¹•å¯†ç›Ÿæ¨¡è¨³éƒµå„ªé å¹¼æ¬²ç¿Œä¹±åµè¦§è£å¾‹è‡¨æœ—è«–"
        };

        const mojibakeMap = { 'å”„': '(1)', 'æ¬': '(2)', 'è”š': '(3)', 'é°»': '(4)', 'å§¥': '(5)', 'å©': '(6)', 'æµ¦': '(7)', 'ç“œ': '(8)', 'é–': '(9)', 'å™‚': '(10)' };

        window.onload = function () {
            const refArea = document.getElementById("kanjiReference");
            let html = "";
            for (let g = 1; g <= 6; g++) {
                const count = kanjiDb[g].length;
                html += `<div class="grade-block"><div class="grade-title"><span>${g}å¹´ç”Ÿ</span><span class="grade-count">${count}æ–‡å­—</span></div><div class="kanji-list">${kanjiDb[g]}</div></div>`;
            }
            refArea.innerHTML = html;
        };

        function toggleKanjiList() {
            const refArea = document.getElementById("kanjiReference");
            const btn = document.getElementById("toggleBtn");
            const isOpen = refArea.style.display === "block";
            refArea.style.display = isOpen ? "none" : "block";
            btn.innerText = isOpen ? "â–¼ å„å­¦å¹´ã®é…å½“æ¼¢å­—ä¸€è¦§ã‚’è¡¨ç¤ºã™ã‚‹" : "â–² ä¸€è¦§ã‚’é–‰ã˜ã‚‹";
        }

        function getFuriganaAt(text, index) {
            if (index >= text.length) return null;
            const nextChar = text[index];
            if (nextChar === "ï¼ˆ" || nextChar === "(") {
                const closing = (nextChar === "ï¼ˆ") ? "ï¼‰" : ")";
                const endIdx = text.indexOf(closing, index);
                if (endIdx !== -1) return text.substring(index + 1, endIdx);
            }
            return null;
        }

        function analyzeText() {
            let text = document.getElementById("inputText").value;
            const targetGradeStart = parseInt(document.getElementById("gradeSelect").value);
            const proofreadOn = document.getElementById("proofreadMode").checked;
            const outputArea = document.getElementById("outputArea");
            const colorMode = document.querySelector('input[name="colorMode"]:checked').value;
            const sourceMode = document.querySelector('input[name="sourceMode"]:checked').value;
            outputArea.className = (colorMode === "allred") ? "mode-allred" : "mode-split";

            text = text.replace(/[\(ï¼ˆ]æˆ–[\)ï¼‰]/g, 'ã ').replace(/æˆ–/g, 'ã ');
            text = text.replace(/[\(ï¼ˆ]å®‰[\)ï¼‰]/g, 'ã¤').replace(/([0-9ï¼-ï¼™])å®‰/g, '$1ã¤');

            if (proofreadOn) {
                // èª­ç‚¹
                text = text.replace(/ã€/g, `__TYPO_START__ã€__TYPO_END__HINT__ã‚«ãƒ³ãƒã«ç›´ã—ã¦ï¼__`);
                // æ•°å­—
                text = text.replace(/[0-9ï¼-ï¼™\.ï¼]+/g, (match) => {
                    const len = match.replace(/[\.ï¼]/g, '').length;
                    const hasFull = /[ï¼-ï¼™ï¼]/.test(match);
                    const hasHalf = /[0-9\.]/.test(match);
                    if (len === 1 && hasHalf) return `__TYPO_START__${match}__TYPO_END__HINT__å…¨è§’ã«ã—ã¦ï¼__`;
                    if (len >= 2 && hasFull) return `__TYPO_START__${match}__TYPO_END__HINT__åŠè§’ã«ã—ã¦ï¼__`;
                    return match;
                });
            }
            for (const [key, val] of Object.entries(mojibakeMap)) { text = text.replaceAll(key, val); }
            if (document.getElementById("formatText")?.checked !== false) {
                text = text.replace(/\n{3,}/g, '__DOUBLE__').replace(/\n{2}/g, '__SINGLE__').replace(/\n/g, '').replace(/__DOUBLE__/g, '\n\n').replace(/__SINGLE__/g, '\n');
            }

            let seenKanjiFuriMap = {};
            let finalHtml = "";
            text.split('\n').forEach((line) => {
                let lineHtml = "";
                for (let i = 0; i < line.length; i++) {
                    if (line.startsWith("__TYPO_START__", i)) {
                        const endIdx = line.indexOf("__TYPO_END__", i);
                        const hintIdx = line.indexOf("__HINT__", endIdx);
                        const typoWord = line.substring(i + 14, endIdx);
                        const hintText = line.substring(hintIdx + 8, line.indexOf("__", hintIdx + 8));
                        lineHtml += `<span class="typo-alert" data-hint="${hintText}">${typoWord}</span>`;
                        i = line.indexOf("__", hintIdx + 8) + 1; continue;
                    }
                    const char = line[i];
                    const charGrade = getKanjiGrade(char);
                    if (charGrade !== null && charGrade >= targetGradeStart) {
                        const currentFuri = getFuriganaAt(line, i + 1);
                        let isFirst = !(char in seenKanjiFuriMap);
                        let cssClass = "kanji-target " + (isFirst ? "kanji-first" : "kanji-repeat");
                        if (isFirst) seenKanjiFuriMap[char] = currentFuri;
                        if (sourceMode === 'ichitaro') {
                            if (colorMode === "allred" && !currentFuri) cssClass += " warning-missing-furigana";
                            else if (colorMode === "split") {
                                if (isFirst && !currentFuri) cssClass += " warning-missing-furigana";
                                else if (!isFirst && currentFuri) {
                                    if (seenKanjiFuriMap[char] !== currentFuri) cssClass += " warning-check-furigana";
                                    else cssClass += " warning-extra-furigana";
                                }
                            }
                        }
                        lineHtml += `<span class="${cssClass}">${char}</span>`;
                    } else { lineHtml += char; }
                }
                finalHtml += lineHtml + "<br>";
            });
            outputArea.innerHTML = finalHtml;
        }
        function getKanjiGrade(char) {
            for (let g = 1; g <= 6; g++) { if (kanjiDb[g].includes(char)) return g; }
            return char.match(/[\u4E00-\u9FFF]/) ? 7 : null;
        }
    </script>

</body>

</html>