<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å…¥è©¦ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ»ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

<script src="school_data.js"></script>

<style>
    /* === åŸºæœ¬ãƒ‡ã‚¶ã‚¤ãƒ³è¨­å®š === */
    :root {
        --primary-color: #37474f;
        --accent-blue: #0288d1;
        --accent-red: #d32f2f;
        --bg-color: #f0f2f5;
        --panel-bg: #ffffff;
        --border-color: #e0e0e0;
        --slot-valid-bg: #e1f5fe;
        --slot-valid-border: #29b6f6;
        --slot-invalid-bg: #ffebee;
        --slot-invalid-border: #ef5350;
    }

    * { box-sizing: border-box; }
    html, body {
        height: 100%; margin: 0; padding: 0;
        font-family: "Helvetica Neue", "Arial", "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
        background-color: var(--bg-color);
        overflow: hidden; 
        color: #333;
    }

    /* === ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¨ãƒªã‚¢ === */
    #header-area {
        background: var(--panel-bg);
        border-bottom: 1px solid var(--border-color);
        height: 60px;
        display: flex; align-items: center; justify-content: space-between;
        padding: 0 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        flex-shrink: 0; z-index: 50;
    }

    .header-left { display: flex; align-items: center; gap: 15px; }

    .app-title { font-size: 18px; font-weight: bold; color: var(--primary-color); white-space: nowrap; }
    
    /* â˜…è¿½åŠ : èª¬æ˜æ›¸ãã‚¨ãƒªã‚¢ */
    .app-desc {
        font-size: 11px; color: #555;
        background: #f1f8e9; padding: 4px 10px; border-radius: 4px; border: 1px solid #c5e1a5;
        display: flex; align-items: center; gap: 5px;
    }

    .header-actions { display: flex; align-items: center; gap: 20px; }

    .legend { font-size: 11px; color: #666; display: flex; gap: 12px; align-items: center; background: #fafafa; padding: 5px 10px; border-radius: 4px; border: 1px solid #eee; }
    .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 4px; }
    .dot.valid { background: var(--accent-blue); }
    .dot.invalid { background: var(--accent-red); }

    .btn-group { display: flex; gap: 10px; }
    .btn {
        border: none; padding: 8px 16px; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 12px; transition: all 0.2s;
        display: flex; align-items: center; gap: 5px;
    }
    .btn-reset { background: #fff; border: 1px solid var(--accent-red); color: var(--accent-red); }
    .btn-reset:hover { background: var(--slot-invalid-bg); }
    .btn-print { background: var(--primary-color); color: #fff; }
    .btn-print:hover { background: #263238; }

    /* === ãƒ¡ã‚¤ãƒ³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ === */
    #main-container {
        display: flex; height: calc(100% - 60px); padding: 10px; gap: 10px;
    }

    /* --- å·¦å´ï¼šå­¦æ ¡ã‚¹ãƒˆãƒƒã‚¯ãƒ‘ãƒãƒ« --- */
    #stock-panel {
        width: 250px; flex-shrink: 0;
        background: var(--panel-bg); border-radius: 8px; border: 1px solid var(--border-color);
        display: flex; flex-direction: column; overflow: hidden;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    
    #stock-controls {
        padding: 10px; background: #fff; border-bottom: 1px dashed #ddd;
        display: flex; gap: 8px; flex-direction: column;
    }
    .control-row { display: flex; gap: 5px; }
    .select-wrapper { flex: 1; }
    .select-wrapper select {
        width: 100%; padding: 6px; font-size: 13px; border: 1px solid #ccc; border-radius: 4px;
        background: #f9f9f9; font-weight: bold; color: #444; cursor: pointer;
    }
    .select-wrapper select:hover { background: #fff; }

    .panel-header {
        padding: 8px; background: #eee; border-bottom: 1px solid #ddd;
        font-size: 11px; font-weight: bold; text-align: center; color: #555; display: flex;
    }
    .ph-col { flex: 1; }

    #stock-lists { display: flex; flex: 1; overflow: hidden; }
    .stock-column {
        flex: 1; overflow-y: auto; padding: 8px;
        background: #fafafa; border-right: 1px solid #eee;
        display: flex; flex-direction: column; gap: 6px;
    }
    .stock-column:last-child { border-right: none; }

    .idx-header {
        font-size: 10px; font-weight: bold; color: #999; margin: 8px 0 2px 0; border-bottom: 1px solid #eee;
    }

    /* --- å³å´ï¼šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¨ãƒªã‚¢ --- */
    #calendar-wrapper {
        flex: 1; background: var(--panel-bg); border-radius: 8px; border: 1px solid var(--border-color);
        display: flex; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        position: relative;
    }

    #row-headers {
        width: 35px; flex-shrink: 0;
        border-right: 1px solid #ddd; background: #fcfcfc; z-index: 10;
        display: flex; flex-direction: column; padding-top: 36px;
    }
    .row-label {
        flex: 1; display: flex; align-items: center; justify-content: center;
        writing-mode: vertical-rl; text-orientation: upright;
        font-size: 12px; font-weight: bold; color: #888; letter-spacing: 2px;
        border-bottom: 1px dashed #999; 
        user-select: none;
    }
    .row-label:last-child { border-bottom: none; }

    #calendar-scroll {
        flex: 1; overflow-x: auto; overflow-y: hidden; display: flex;
    }

    .day-column {
        width: 170px; min-width: 170px; flex-shrink: 0;
        border-right: 1px solid #ccc;
        display: flex; flex-direction: column; height: 100%;
    }
    .day-column.new-day { border-left: 2px solid #999; }

    .day-header {
        height: 36px; line-height: 36px; text-align: center;
        font-size: 13px; font-weight: bold; color: #fff;
        background: #546e7a; border-bottom: 1px solid #37474f; flex-shrink: 0;
    }
    .day-header.pm { background: #78909c; }
    .day-header.jan { background: #00838f; }
    .day-header.late { background: #e65100; }

    .slot-container { flex: 1; display: flex; flex-direction: column; }
    
    .slot {
        flex: 1;
        border-bottom: 1px dashed #999;
        padding: 6px;
        overflow-y: auto; overflow-x: hidden;
        transition: background 0.2s; display: flex; flex-direction: column; gap: 6px;
        position: relative;
    }
    .slot:last-child { border-bottom: none; }
    
    .slot.top { background: rgba(255,255,255,0.5); }
    .slot.mid { background: rgba(250,250,250,0.5); }
    .slot.low { background: rgba(245,245,245,0.5); }

    .slot.highlight-valid { background-color: var(--slot-valid-bg) !important; box-shadow: inset 0 0 0 2px var(--slot-valid-border); }
    .slot.highlight-invalid { background-color: var(--slot-invalid-bg) !important; box-shadow: inset 0 0 0 2px var(--slot-invalid-border); }

    .card {
        background: #fff; border: 1px solid #ccc; border-radius: 4px;
        padding: 6px 8px; font-size: 12px; font-weight: bold;
        cursor: grab; box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        border-left-width: 5px; color: #333; user-select: none;
    }
    .type-boy { border-left-color: #2196f3; }
    .type-girl { border-left-color: #e91e63; }
    .type-coed { border-left-color: #4caf50; }

    .card.in-calendar {
        border-left-width: 1px; display: flex; flex-direction: column; gap: 4px; padding: 6px;
    }
    .card.in-calendar.type-boy { border-top: 3px solid #2196f3; }
    .card.in-calendar.type-girl { border-top: 3px solid #e91e63; }
    .card.in-calendar.type-coed { border-top: 3px solid #4caf50; }

    .cal-card-row { display: flex; justify-content: space-between; align-items: center; }
    .ss-badge { background: #455a64; color: #fff; padding: 1px 6px; border-radius: 10px; font-size: 10px; }
    .date-label { color: #d32f2f; font-size: 10px; margin-right: 4px; font-weight: bold; }
    .exam-selector { width: 100%; font-size: 10px; padding: 1px; border: 1px solid #ddd; background: #fff; margin-top: 2px; }

    .sortable-ghost { opacity: 0.4; background: #bdbdbd; }
    .sortable-drag { opacity: 1; transform: scale(1.02); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }

    #print-title { display: none; }
    
    @media print {
        @page { size: A3 landscape; margin: 5mm; }
        body { background: #fff; overflow: visible; -webkit-print-color-adjust: exact; }
        #header-area, #stock-panel { display: none !important; }
        #print-title { display: block; text-align: center; font-size: 24px; font-weight: bold; margin-bottom: 10px; border-bottom: 2px solid #333; }
        #main-container { height: auto; padding: 0; display: block; }
        #calendar-wrapper { border: none; box-shadow: none; display: flex; width: 100%; overflow: visible; }
        #row-headers { display: flex !important; height: auto; border-right: 2px solid #000; padding-top: 30px; }
        .row-label { height: 250px; border-bottom: 1px solid #000; color: #000; flex: none; }
        #calendar-scroll { overflow: visible; display: flex; flex-wrap: wrap; }
        .day-column { flex: 1; min-width: 120px; width: auto; border: 1px solid #000; margin-bottom: -1px; margin-right: -1px; page-break-inside: avoid; }
        .day-header { background: #ccc !important; color: #000 !important; border-bottom: 1px solid #000; font-size: 11px; height: 30px; line-height: 30px; }
        .slot { height: 250px; border-bottom: 1px solid #000; padding: 2px; flex: none; }
        .card.in-calendar { border: 1px solid #000; box-shadow: none; margin-bottom: 2px; }
        select { -webkit-appearance: none; border: none; font-weight: bold; }
    }
</style>
</head>
<body>

    <div id="print-title">å…¥è©¦ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¡¨</div>

    <div id="header-area">
        <div class="header-left">
            <div class="app-title">ğŸ“… å…¥è©¦ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</div>
            <div class="app-desc">
                <span>ğŸ’¡ <b>SS</b>=åå·®å€¤ã€‚æ å†…ã¯SSã®é«˜ã„é †ã«è‡ªå‹•æ•´åˆ—ã—ã¾ã™</span>
            </div>
        </div>

        <div class="header-actions">
            <div class="legend">
                <span><span class="dot valid"></span>å—é¨“å¯</span>
                <span><span class="dot invalid"></span>è¨­å®šãªã—</span>
                <span>ğŸ—‘ï¸ å·¦ã«æˆ»ã—ã¦å‰Šé™¤</span>
            </div>
            <div class="btn-group">
                <button class="btn btn-reset" onclick="App.resetCalendar()">ãƒªã‚»ãƒƒãƒˆ</button>
                <button class="btn btn-print" onclick="window.print()">ğŸ–¨ï¸ å°åˆ·</button>
            </div>
        </div>
    </div>

    <div id="main-container">
        <div id="stock-panel">
            <div id="stock-controls">
                <div class="control-row">
                    <div class="select-wrapper">
                        <select id="gender-select">
                            <option value="boy">ğŸ‘¦ ç”·å­å—é¨“</option>
                            <option value="girl">ğŸ‘§ å¥³å­å—é¨“</option>
                        </select>
                    </div>
                    <div class="select-wrapper">
                        <select id="region-select">
                            <option value="feb" selected>ğŸ—¼ 2æœˆæ ¡</option>
                            <option value="jan">ğŸ 1æœˆæ ¡</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="panel-header"><div class="ph-col" id="header-gender-label">ç”·å­æ ¡</div><div class="ph-col">å…±å­¦æ ¡</div></div>
            <div id="stock-lists">
                <div id="stock-gender" class="stock-column"></div>
                <div id="stock-coed" class="stock-column"></div>
            </div>
        </div>

        <div id="calendar-wrapper">
            <div id="row-headers"><div class="row-label">ãƒãƒ£ãƒ¬ãƒ³ã‚¸</div><div class="row-label">å®ŸåŠ›ç›¸å¿œ</div><div class="row-label">å®‰å…¨åœ</div></div>
            <div id="calendar-scroll"></div>
        </div>
    </div>

<script>
// --- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å®šç¾© ---
const CALENDAR_DEF = [
    { id: "jan_early", label: "1æœˆ å‰åŠ", type: "jan", newDay: true },
    { id: "jan_late",  label: "1æœˆ å¾ŒåŠ", type: "jan", newDay: false },
    { id: "feb1_am", label: "2/1 AM", type: "am", newDay: true }, { id: "feb1_pm", label: "2/1 PM", type: "pm", newDay: false },
    { id: "feb2_am", label: "2/2 AM", type: "am", newDay: true }, { id: "feb2_pm", label: "2/2 PM", type: "pm", newDay: false },
    { id: "feb3_am", label: "2/3 AM", type: "am", newDay: true }, { id: "feb3_pm", label: "2/3 PM", type: "pm", newDay: false },
    { id: "feb4_am", label: "2/4 AM", type: "am", newDay: true }, { id: "feb4_pm", label: "2/4 PM", type: "pm", newDay: false },
    { id: "feb5", label: "2/5", type: "am", newDay: true }, { id: "feb6_etc", label: "2/6ä»¥é™", type: "late", newDay: true }
];

const App = {
    data: [],

    init: function() {
        if (window.SCHOOL_DATA) {
            this.data = window.SCHOOL_DATA;
        } else {
            alert("ã‚¨ãƒ©ãƒ¼: 'school_data.js' ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚\nåŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã«ã‚ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            return;
        }
        this.renderCalendar();
        this.bindEvents();
        this.refreshStock();
    },

    bindEvents: function() {
        document.getElementById('gender-select').addEventListener('change', () => this.refreshStock());
        document.getElementById('region-select').addEventListener('change', () => this.refreshStock());
    },

    renderCalendar: function() {
        const area = document.getElementById('calendar-scroll');
        area.innerHTML = "";
        CALENDAR_DEF.forEach(col => {
            const wrapper = document.createElement('div');
            wrapper.className = `day-column${col.newDay ? ' new-day' : ''}`;
            wrapper.innerHTML = `<div class="day-header ${col.type}">${col.label}</div><div class="slot-container"><div class="slot top" data-slot-id="${col.id}"></div><div class="slot mid" data-slot-id="${col.id}"></div><div class="slot low" data-slot-id="${col.id}"></div></div>`;
            area.appendChild(wrapper);
        });

        document.querySelectorAll('.slot').forEach(slot => {
            new Sortable(slot, {
                group: 'schools', animation: 150, ghostClass: 'sortable-ghost', dragClass: 'sortable-drag',
                onMove: (evt) => {
                    document.querySelectorAll('.slot').forEach(s => s.classList.remove('highlight-valid', 'highlight-invalid'));
                    const schoolId = evt.dragged.getAttribute('data-id');
                    const slotId = evt.to.getAttribute('data-slot-id');
                    if (slotId) {
                        const school = this.data.find(s => s.id === schoolId);
                        if (school && school.exams[slotId]) { evt.to.classList.add('highlight-valid'); }
                        else { evt.to.classList.add('highlight-invalid'); }
                        return true;
                    }
                },
                onEnd: () => { document.querySelectorAll('.slot').forEach(s => s.classList.remove('highlight-valid', 'highlight-invalid')); },
                onAdd: (evt) => {
                    this.transformToCalendarCard(evt.item, evt.to.getAttribute('data-slot-id'));
                    this.sortSlot(evt.to);
                }
            });
        });
    },

    refreshStock: function() {
        const gender = document.getElementById('gender-select').value;
        const region = document.getElementById('region-select').value;
        const containerG = document.getElementById('stock-gender');
        const containerC = document.getElementById('stock-coed');
        containerG.innerHTML = ""; containerC.innerHTML = "";
        document.getElementById('header-gender-label').innerText = (gender === 'boy') ? "ç”·å­æ ¡" : "å¥³å­æ ¡";

        const filtered = this.data.filter(s => s.region === region);
        filtered.sort((a,b) => a.kana.localeCompare(b.kana, 'ja'));

        const genderList = filtered.filter(s => (gender === 'boy' && s.type === 'boy') || (gender === 'girl' && s.type === 'girl'));
        const coedList = filtered.filter(s => s.type === 'coed');

        this.fillStockColumn(containerG, genderList);
        this.fillStockColumn(containerC, coedList);
    },

    fillStockColumn: function(container, list) {
        let lastIndex = "";
        list.forEach(school => {
            const idx = this.getIndexChar(school.kana);
            if (idx !== lastIndex) {
                const header = document.createElement('div'); header.className = 'idx-header'; header.innerText = idx;
                container.appendChild(header); lastIndex = idx;
            }
            const card = document.createElement('div');
            card.className = `card type-${school.type}`; card.setAttribute('data-id', school.id); card.innerText = school.name;
            container.appendChild(card);
        });
        new Sortable(container, {
            group: { name: 'schools', pull: 'clone', put: true }, sort: false, animation: 150,
            onAdd: (evt) => { evt.item.parentNode.removeChild(evt.item); }
        });
    },

    transformToCalendarCard: function(el, slotId) {
        const id = el.getAttribute('data-id');
        const school = this.data.find(s => s.id === id);
        el.className = `card in-calendar type-${school.type}`; el.innerHTML = "";
        if (school.exams && school.exams[slotId]) {
            const exams = school.exams[slotId];
            const cur = exams[0];
            el.setAttribute('data-ss', cur.ss);
            el.innerHTML = `<div class="cal-card-row"><div><span class="date-label">${cur.date || ''}</span><span class="school-name">${school.name}</span></div><span class="ss-badge">${cur.ss}</span></div>`;
            const sel = document.createElement('select'); sel.className = 'exam-selector';
            exams.forEach((ex, i) => {
                const opt = document.createElement('option'); opt.value = i; opt.text = `${ex.date?`[${ex.date}] `:''}${ex.name} (SS:${ex.ss})`;
                sel.appendChild(opt);
            });
            sel.addEventListener('change', (e) => {
                const ex = exams[e.target.value];
                el.setAttribute('data-ss', ex.ss);
                el.querySelector('.ss-badge').innerText = ex.ss;
                el.querySelector('.date-label').innerText = ex.date || '';
                this.sortSlot(el.parentNode);
            });
            sel.addEventListener('mousedown', (e) => e.stopPropagation());
            el.appendChild(sel);
        } else {
            el.style.background = "#eee"; el.setAttribute('data-ss', 0);
            el.innerHTML = `<span class="school-name">${school.name}</span><div style="font-size:10px; color:red;">è©¦é¨“ãªã—</div>`;
        }
    },

    sortSlot: function(container) {
        Array.from(container.children).sort((a, b) => (parseInt(b.getAttribute('data-ss')||0) - parseInt(a.getAttribute('data-ss')||0))).forEach(item => container.appendChild(item));
    },

    getIndexChar: function(kana) {
        if (!kana) return "ä»–"; const c = kana.charAt(0);
        if (/[ã‚-ãŠ]/.test(c)) return "ã‚è¡Œ"; if (/[ã‹-ã“]/.test(c)) return "ã‹è¡Œ"; if (/[ã•-ã]/.test(c)) return "ã•è¡Œ";
        if (/[ãŸ-ã¨]/.test(c)) return "ãŸè¡Œ"; if (/[ãª-ã®]/.test(c)) return "ãªè¡Œ"; if (/[ã¯-ã»]/.test(c)) return "ã¯è¡Œ";
        if (/[ã¾-ã‚‚]/.test(c)) return "ã¾è¡Œ"; if (/[ã‚„-ã‚ˆ]/.test(c)) return "ã‚„è¡Œ"; if (/[ã‚‰-ã‚]/.test(c)) return "ã‚‰è¡Œ";
        if (/[ã‚-ã‚“]/.test(c)) return "ã‚è¡Œ"; return "ä»–";
    },

    resetCalendar: function() { if(confirm('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’å…¨ã¦ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) document.querySelectorAll('.slot').forEach(s => s.innerHTML = ""); }
};

window.addEventListener('DOMContentLoaded', () => App.init());
</script>
</body>
</html>