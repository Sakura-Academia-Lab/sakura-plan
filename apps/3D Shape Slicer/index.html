<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-YV5WWWG39Z"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-YV5WWWG39Z');
  </script>

  <script>(function (w, d, s, l, i) {
      w[l] = w[l] || []; w[l].push({
        'gtm.start':
          new Date().getTime(), event: 'gtm.js'
      }); var f = d.getElementsByTagName(s)[0],
        j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : ''; j.async = true; j.src =
          'https://www.googletagmanager.com/gtm.js?id=' + i + dl; f.parentNode.insertBefore(j, f);
    })(window, document, 'script', 'dataLayer', 'GTM-PRPCBPS2');</script>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç«‹ä½“å›³å½¢ã‚¹ãƒ©ã‚¤ã‚µãƒ¼ | æ¡œã‚¢ã‚«ãƒ‡ãƒŸã‚¢</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      overflow: hidden;
      background-color: #fdfcf5;
      font-family: "Helvetica Neue", Arial, sans-serif;
    }

    /* ===== ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ ===== */
    #top-nav {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
      background: rgba(255, 255, 255, 0.98);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      padding: 8px 12px;
      gap: 8px;
      flex-wrap: wrap;
    }

    .nav-tab {
      background: #f5f5f5;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 8px 14px;
      font-size: 13px;
      font-weight: bold;
      color: #555;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: 0.2s;
      white-space: nowrap;
    }

    .nav-tab:hover {
      background: #e8e8e8;
    }

    .nav-tab.active {
      background: #a8d5e2;
      border-color: #81b3c3;
      color: #005662;
    }

    .nav-tab::after {
      content: 'â–¼';
      font-size: 10px;
      opacity: 0.6;
    }

    .dropdown-panel {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      margin-top: 4px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      padding: 12px;
      min-width: 320px;
      max-height: 80vh;
      overflow-y: auto;
      z-index: 200;
    }

    .dropdown-panel.open {
      display: block;
    }

    .section-title {
      font-size: 11px;
      font-weight: bold;
      color: #888;
      margin: 10px 0 6px 0;
      padding-bottom: 4px;
      border-bottom: 1px dashed #ddd;
    }

    .btn-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
    }

    .grid-btn {
      padding: 8px 4px;
      font-size: 11px;
      cursor: pointer;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: #fff;
      color: #666;
      transition: 0.2s;
    }

    .grid-btn.active {
      background: #a8d5e2;
      color: #005662;
      border-color: #81b3c3;
      font-weight: bold;
    }

    .param-area {
      display: none;
      background: #eef7ff;
      padding: 12px;
      border-radius: 8px;
      margin: 8px 0;
      border: 1px solid #cce4f7;
    }

    .param-area.show {
      display: block;
    }

    .param-row {
      display: flex;
      gap: 10px;
      align-items: flex-end;
    }

    .param-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .param-item span {
      font-size: 10px;
      color: #666;
      margin-bottom: 4px;
    }

    .param-item input {
      width: 100%;
      padding: 8px;
      text-align: center;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 15px;
      font-weight: bold;
    }

    .btn-confirm {
      background: #4facfe;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      font-size: 12px;
      margin-top: 10px;
      width: 100%;
    }

    /* ===== åˆ‡æ–­ã‚»ã‚¯ã‚·ãƒ§ãƒ³ ===== */
    .cut-section {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-left: 10px;
      flex: 1;
    }

    .cut-tabs-wrapper {
      background: #eee;
      border-radius: 20px;
      padding: 3px;
      overflow-x: auto;
      max-width: 700px;
      scrollbar-width: none;
    }

    .cut-tabs-wrapper::-webkit-scrollbar {
      display: none;
    }

    .cut-tabs {
      display: flex;
      gap: 2px;
    }

    .cut-tab {
      background: transparent;
      border: none;
      padding: 6px 14px;
      border-radius: 14px;
      font-weight: bold;
      color: #888;
      cursor: pointer;
      font-size: 11px;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .cut-tab.active {
      background: #fff;
      color: #ff9800;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .cut-tab.has-cut {
      color: #4CAF50;
    }

    .controls-right {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-left: auto;
    }

    #status-box {
      font-size: 13px;
      font-weight: bold;
      color: #555;
      min-width: 45px;
      text-align: center;
    }

    #btn-flip {
      background: #ffb74d;
      color: white;
      border: none;
      padding: 8px 14px;
      border-radius: 12px;
      font-weight: bold;
      cursor: pointer;
      display: none;
      font-size: 12px;
      white-space: nowrap;
    }

    .btn-all-reset {
      background: #ef5350;
      color: white;
      border: none;
      padding: 8px 14px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      font-size: 12px;
    }

    /* ===== ãƒ˜ãƒ«ãƒ—ãƒ‘ãƒãƒ« ===== */
    .help-btn {
      background: #9575cd;
      border: 1px solid #7e57c2;
      border-radius: 8px;
      padding: 8px 14px;
      font-size: 13px;
      font-weight: bold;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: 0.2s;
      white-space: nowrap;
      margin-left: auto;
    }

    .help-btn:hover {
      background: #7e57c2;
    }

    .help-btn::after {
      content: '';
    }

    .help-panel {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 4px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      padding: 16px;
      min-width: 280px;
      z-index: 200;
    }

    .help-panel.open {
      display: block;
    }

    .help-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 8px 0;
      border-bottom: 1px dashed #eee;
    }

    .help-item:last-child {
      border-bottom: none;
    }

    .help-icon {
      font-size: 20px;
      min-width: 30px;
      text-align: center;
    }

    .help-text {
      font-size: 13px;
      color: #555;
      line-height: 1.5;
    }

    .help-text strong {
      color: #333;
    }

    @media (max-width: 950px) {
      .cut-section {
        width: 100%;
        margin-left: 0;
        border-top: 1px solid #eee;
        padding-top: 6px;
        order: 3;
      }

      .dropdown-panel {
        width: 95vw;
        left: 2.5vw;
      }
    }
  </style>
</head>

<body>
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PRPCBPS2" height="0" width="0"
      style="display:none;visibility:hidden"></iframe></noscript>

  <nav id="top-nav">
    <div class="nav-tab" onclick="toggleDropdown('panel-shape')">ğŸ“ å›³å½¢é¸æŠ</div>
    <div class="help-btn" onclick="toggleDropdown('panel-help')">â“ æ“ä½œã‚¬ã‚¤ãƒ‰</div>
    <div class="help-panel" id="panel-help">
      <div class="help-item">
        <span class="help-icon">â˜ï¸</span>
        <div class="help-text"><strong>1æœ¬æŒ‡ã§ãƒ‰ãƒ©ãƒƒã‚°</strong><br>ç«‹ä½“ã‚’å›è»¢ã•ã›ã‚‹</div>
      </div>
      <div class="help-item">
        <span class="help-icon">âœŒï¸</span>
        <div class="help-text"><strong>2æœ¬æŒ‡ã§ãƒ‰ãƒ©ãƒƒã‚°</strong><br>ç«‹ä½“ã‚’ä¸Šä¸‹å·¦å³ã«ç§»å‹•ã•ã›ã‚‹</div>
      </div>
      <div class="help-item">
        <span class="help-icon">ğŸ¤</span>
        <div class="help-text"><strong>ãƒ”ãƒ³ãƒã‚¤ãƒ³/ã‚¢ã‚¦ãƒˆ</strong><br>æ‹¡å¤§ãƒ»ç¸®å°ã™ã‚‹</div>
      </div>
      <div class="help-item">
        <span class="help-icon">ğŸ‘†</span>
        <div class="help-text"><strong>ç‚¹ã‚’ã‚¿ãƒƒãƒ—</strong><br>åˆ‡æ–­ç‚¹ã‚’é¸æŠï¼ˆ3ç‚¹ã§åˆ‡æ–­ï¼‰</div>
      </div>
    </div>
    <div class="dropdown-panel" id="panel-shape">
      <div class="section-title">åŸºæœ¬å›³å½¢</div>
      <div class="btn-grid">
        <button class="grid-btn active" id="btn-cube" onclick="setShapeUI('cube')">ç«‹æ–¹ä½“</button>
        <button class="grid-btn" id="btn-box" onclick="setShapeUI('box')">ç›´æ–¹ä½“</button>
        <button class="grid-btn" id="btn-sphere" onclick="setShapeUI('sphere')">çƒ</button>
      </div>

      <div id="cube-params" class="param-area">
        <div class="param-row">
          <div class="param-item"><span>ä¸€è¾ºã®é•·ã•</span><input type="number" id="inp-cube-s" value="7" min="2" max="12"
              onchange="setShape('cube')"></div>
        </div>
        <button class="btn-confirm" onclick="closeAll()">OK æ±ºå®šã—ã¦é–‰ã˜ã‚‹</button>
      </div>
      <div id="box-params" class="param-area">
        <div class="param-row">
          <div class="param-item"><span>æ¨ª</span><input type="number" id="inp-w" value="5" onchange="setShape('box')">
          </div>
          <div class="param-item"><span>é«˜</span><input type="number" id="inp-h" value="8" onchange="setShape('box')">
          </div>
          <div class="param-item"><span>å¥¥</span><input type="number" id="inp-d" value="5" onchange="setShape('box')">
          </div>
        </div>
        <button class="btn-confirm" onclick="closeAll()">OK æ±ºå®šã—ã¦é–‰ã˜ã‚‹</button>
      </div>

      <div class="section-title">æŸ±ä½“ãƒ»éŒä½“ãƒ»å¤šé¢ä½“</div>
      <div class="btn-grid">
        <button class="grid-btn" onclick="setShapeUI('prism-3')">ä¸‰è§’æŸ±</button>
        <button class="grid-btn" onclick="setShapeUI('prism-5')">äº”è§’æŸ±</button>
        <button class="grid-btn" onclick="setShapeUI('prism-6')">å…­è§’æŸ±</button>
        <button class="grid-btn" onclick="setShapeUI('cylinder')">å††æŸ±</button>
        <button class="grid-btn" onclick="setShapeUI('pyramid-3')">ä¸‰è§’éŒ</button>
        <button class="grid-btn" onclick="setShapeUI('pyramid-4')">å››è§’éŒ</button>
        <button class="grid-btn" onclick="setShapeUI('pyramid-5')">äº”è§’éŒ</button>
        <button class="grid-btn" onclick="setShapeUI('pyramid-6')">å…­è§’éŒ</button>
        <button class="grid-btn" onclick="setShapeUI('cone')">å††éŒ</button>
        <button class="grid-btn" onclick="setShapeUI('poly-4')">æ­£å››é¢ä½“</button>
        <button class="grid-btn" onclick="setShapeUI('poly-8')">æ­£å…«é¢ä½“</button>
        <button class="grid-btn" onclick="setShapeUI('poly-12')">æ­£åäºŒé¢ä½“</button>
        <button class="grid-btn" onclick="setShapeUI('poly-20')">æ­£äºŒåé¢ä½“</button>
      </div>
    </div>

    <div class="nav-tab" onclick="toggleDropdown('panel-snap')">ğŸ“ ç­‰åˆ†ç‚¹è¨­å®š</div>
    <div class="dropdown-panel" id="panel-snap">
      <div class="section-title">ã‚¨ãƒƒã‚¸ã®åˆ†å‰²æ•°</div>
      <div class="btn-grid">
        <button class="grid-btn active snap-ui" onclick="setDivisionUI(1)">é ‚ç‚¹ã®ã¿</button>
        <button class="grid-btn snap-ui" onclick="setDivisionUI(2)">2ç­‰åˆ†</button>
        <button class="grid-btn snap-ui" onclick="setDivisionUI(3)">3ç­‰åˆ†</button>
        <button class="grid-btn snap-ui" onclick="setDivisionUI(4)">4ç­‰åˆ†</button>
        <button class="grid-btn snap-ui" onclick="setDivisionUI(5)">5ç­‰åˆ†</button>
        <button class="grid-btn snap-ui" onclick="setDivisionUI(6)">6ç­‰åˆ†</button>
        <button class="grid-btn snap-ui" onclick="setDivisionUI(8)">8ç­‰åˆ†</button>
        <button class="grid-btn snap-ui" onclick="setDivisionUI(10)">10ç­‰åˆ†</button>
      </div>
    </div>

    <div class="cut-section">
      <div class="cut-tabs-wrapper">
        <div class="cut-tabs">
          <button class="cut-tab active" id="tab-0" onclick="switchCutTab(0)">åˆ‡æ–­â‘ </button>
          <button class="cut-tab" id="tab-1" onclick="switchCutTab(1)">åˆ‡æ–­â‘¡</button>
          <button class="cut-tab" id="tab-2" onclick="switchCutTab(2)">åˆ‡æ–­â‘¢</button>
          <button class="cut-tab" id="tab-3" onclick="switchCutTab(3)">åˆ‡æ–­â‘£</button>
          <button class="cut-tab" id="tab-4" onclick="switchCutTab(4)">åˆ‡æ–­â‘¤</button>
          <button class="cut-tab" id="tab-5" onclick="switchCutTab(5)">åˆ‡æ–­â‘¥</button>
          <button class="cut-tab" id="tab-6" onclick="switchCutTab(6)">åˆ‡æ–­â‘¦</button>
          <button class="cut-tab" id="tab-7" onclick="switchCutTab(7)">åˆ‡æ–­â‘§</button>
        </div>
      </div>
      <div class="controls-right">
        <span id="status-box">0 / 3</span>
        <button id="btn-flip" onclick="flipCurrentCut()">ğŸ” é€†å´</button>
        <button class="btn-all-reset" onclick="resetAll()">ğŸ—‘ å…¨ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
    </div>
  </nav>

  <script>
    let scene, camera, renderer, controls;
    let planes = [], cutPoints = [], cutMarkers = [], capMeshes = [], currentCutIndex = 0;
    const MAX_CUTS = 8;
    let currentMesh, wireMesh, currentGeo, currentEdgesGeo;
    let snapGroup = new THREE.Group(), intersectGroup = new THREE.Group();
    let openDropdown = null;

    function toggleDropdown(id) {
      const panel = document.getElementById(id);
      if (openDropdown && openDropdown !== panel) openDropdown.classList.remove('open');
      panel.classList.toggle('open');
      openDropdown = panel.classList.contains('open') ? panel : null;
    }
    function closeAll() { if (openDropdown) { openDropdown.classList.remove('open'); openDropdown = null; } }

    function setShapeUI(type) {
      document.querySelectorAll('#panel-shape .grid-btn').forEach(b => b.classList.remove('active'));
      const activeBtn = Array.from(document.querySelectorAll('#panel-shape .grid-btn')).find(b => b.textContent.includes(type) || (type === 'cube' && b.textContent === 'ç«‹æ–¹ä½“'));
      if (activeBtn) activeBtn.classList.add('active');
      document.getElementById('cube-params').classList.toggle('show', type === 'cube');
      document.getElementById('box-params').classList.toggle('show', type === 'box');
      setShape(type);
      if (type !== 'cube' && type !== 'box') closeAll();
    }

    function setDivisionUI(div) { setDivision(div); closeAll(); }

    function init() {
      scene = new THREE.Scene(); scene.background = new THREE.Color(0xfdfcf5);
      camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000); camera.position.set(20, 20, 26);
      renderer = new THREE.WebGLRenderer({ antialias: true }); renderer.setSize(window.innerWidth, window.innerHeight); renderer.localClippingEnabled = true;
      document.body.appendChild(renderer.domElement);
      controls = new THREE.OrbitControls(camera, renderer.domElement); controls.enableDamping = true;
      const ambientLight = new THREE.AmbientLight(0x808080); scene.add(ambientLight);
      const dirLight = new THREE.DirectionalLight(0xffffff, 0.8); dirLight.position.set(10, 20, 10); scene.add(dirLight);

      for (let i = 0; i < MAX_CUTS; i++) {
        planes.push(new THREE.Plane(new THREE.Vector3(0, -1, 0), 10000));
        cutPoints.push([]); cutMarkers.push([]); capMeshes.push(null);
      }
      scene.add(snapGroup, intersectGroup);
      setShape('cube'); animate();
    }

    function setShape(type) {
      if (currentMesh) { scene.remove(currentMesh, wireMesh); capMeshes.forEach(c => scene.remove(c)); capMeshes.fill(null); }
      let geo, edgeGeo;
      if (type === 'cube') {
        const s = parseFloat(document.getElementById('inp-cube-s').value);
        geo = new THREE.BoxGeometry(s, s, s);
        edgeGeo = new THREE.EdgesGeometry(geo);
      } else if (type === 'box') {
        geo = new THREE.BoxGeometry(parseFloat(document.getElementById('inp-w').value), parseFloat(document.getElementById('inp-h').value), parseFloat(document.getElementById('inp-d').value));
        edgeGeo = new THREE.EdgesGeometry(geo);
      } else if (type === 'sphere') {
        geo = new THREE.SphereGeometry(6, 48, 48); // è¡¨ç¤ºç”¨ã¯æ»‘ã‚‰ã‹
        edgeGeo = new THREE.EdgesGeometry(new THREE.SphereGeometry(6, 6, 4)); // ã‚¹ãƒŠãƒƒãƒ—ç”¨ã¯æ¥µé™ã¾ã§ä½å¯†åº¦ã«
      } else if (type.includes('prism')) {
        const seg = parseInt(type.split('-')[1]) || 32;
        geo = new THREE.CylinderGeometry(5, 5, 9, seg);
        edgeGeo = new THREE.EdgesGeometry(geo, 15);
      } else if (type.includes('pyramid')) {
        const seg = parseInt(type.split('-')[1]) || 32;
        geo = new THREE.ConeGeometry(6, 9, seg);
        edgeGeo = new THREE.EdgesGeometry(geo, 15);
      } else if (type === 'cylinder') {
        geo = new THREE.CylinderGeometry(4, 4, 9, 32); // è¡¨ç¤ºç”¨ã¯æ»‘ã‚‰ã‹
        edgeGeo = new THREE.EdgesGeometry(new THREE.CylinderGeometry(4, 4, 9, 8), 15); // ã‚¹ãƒŠãƒƒãƒ—ç”¨ã¯ä½å¯†åº¦
      } else if (type === 'cone') {
        geo = new THREE.ConeGeometry(6, 9, 32); // è¡¨ç¤ºç”¨ã¯æ»‘ã‚‰ã‹
        edgeGeo = new THREE.EdgesGeometry(new THREE.ConeGeometry(6, 9, 8), 15); // ã‚¹ãƒŠãƒƒãƒ—ç”¨ã¯ä½å¯†åº¦
      } else {
        geo = new THREE.CylinderGeometry(4, 4, 9, 32);
        edgeGeo = new THREE.EdgesGeometry(new THREE.CylinderGeometry(4, 4, 9, 8), 15);
      }
      geo.translate(3, 0, 0); edgeGeo.translate(3, 0, 0);
      currentGeo = geo; currentEdgesGeo = edgeGeo;
      currentMesh = new THREE.Mesh(geo, new THREE.MeshPhongMaterial({ color: 0xa8d5e2, side: THREE.DoubleSide, clippingPlanes: planes, clipShadows: true }));
      wireMesh = new THREE.LineSegments(edgeGeo, new THREE.LineBasicMaterial({ color: 0x000000, opacity: 0.3, transparent: true }));
      scene.add(currentMesh, wireMesh);
      resetAll();
    }

    function setDivision(div) {
      snapGroup.clear(); const attr = currentEdgesGeo.attributes.position;
      const stepLimit = (currentMesh.geometry.type === "SphereGeometry") ? 1 : div; // çƒä½“ã¯ç­‰åˆ†ç‚¹ã‚’ã‚¨ãƒƒã‚¸ä¸­å¤®ã«ä½œã‚‰ãªã„
      for (let i = 0; i < attr.count; i += 2) {
        const v1 = new THREE.Vector3().fromBufferAttribute(attr, i), v2 = new THREE.Vector3().fromBufferAttribute(attr, i + 1);
        for (let j = 0; j <= stepLimit; j++) {
          const dot = new THREE.Mesh(new THREE.SphereGeometry(0.2), new THREE.MeshBasicMaterial({ color: 0x555555, opacity: 0.4, transparent: true }));
          dot.position.lerpVectors(v1, v2, j / stepLimit); snapGroup.add(dot);
        }
      }
    }

    function calculateIntersectionPointsAndCreateCap(plane, idx) {
      const pts = []; const attr = currentEdgesGeo.attributes.position;
      for (let i = 0; i < attr.count; i += 2) {
        const v1 = new THREE.Vector3().fromBufferAttribute(attr, i), v2 = new THREE.Vector3().fromBufferAttribute(attr, i + 1);
        const line = new THREE.Line3(v1, v2); const target = new THREE.Vector3();
        if (plane.intersectLine(line, target)) if (!pts.some(p => p.distanceTo(target) < 0.01)) pts.push(target.clone());
      }
      if (capMeshes[idx]) scene.remove(capMeshes[idx]);
      if (pts.length >= 3) {
        const center = new THREE.Vector3(); pts.forEach(p => center.add(p)); center.divideScalar(pts.length);
        const normal = plane.normal.clone(); let ref = new THREE.Vector3(0, 1, 0); if (Math.abs(normal.dot(ref)) > 0.9) ref.set(1, 0, 0);
        const xDir = ref.cross(normal).normalize(), yDir = normal.clone().cross(xDir).normalize();
        pts.sort((a, b) => Math.atan2(a.clone().sub(center).dot(yDir), a.clone().sub(center).dot(xDir)) - Math.atan2(b.clone().sub(center).dot(yDir), b.clone().sub(center).dot(xDir)));
        const shape = new THREE.Shape(pts.map(p => new THREE.Vector2(p.clone().sub(center).dot(xDir), p.clone().sub(center).dot(yDir))));
        const cap = new THREE.Mesh(new THREE.ShapeGeometry(shape), new THREE.MeshPhongMaterial({ color: 0x5d99c6, side: THREE.DoubleSide, clippingPlanes: planes.filter((_, i) => i !== idx) }));
        const m = new THREE.Matrix4().makeBasis(xDir, yDir, normal); cap.applyMatrix4(m); cap.position.copy(center);
        capMeshes[idx] = cap; scene.add(cap);
      }
    }

    const raycaster = new THREE.Raycaster(), mouse = new THREE.Vector2();
    window.addEventListener('pointerdown', (e) => {
      if (e.target.closest('#top-nav')) return;
      mouse.x = (e.clientX / window.innerWidth) * 2 - 1; mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
      raycaster.setFromCamera(mouse, camera); const hits = raycaster.intersectObjects(snapGroup.children);
      if (hits.length > 0) {
        const p = hits[0].object.position.clone(); if (cutPoints[currentCutIndex].length >= 3) return;
        cutPoints[currentCutIndex].push(p);
        const m = new THREE.Mesh(new THREE.SphereGeometry(0.35, 12, 10), new THREE.MeshBasicMaterial({ color: 0xff5252 })); m.position.copy(p); scene.add(m); cutMarkers[currentCutIndex].push(m);
        updateUI(); if (cutPoints[currentCutIndex].length === 3) applyCut();
      }
    });

    function applyCut() { const p = cutPoints[currentCutIndex]; planes[currentCutIndex].setFromCoplanarPoints(p[0], p[1], p[2]); calculateIntersectionPointsAndCreateCap(planes[currentCutIndex], currentCutIndex); updateUI(); }
    function updateUI() {
      const len = cutPoints[currentCutIndex].length; document.getElementById('status-box').innerText = `${len} / 3`;
      document.getElementById('btn-flip').style.display = (len === 3) ? 'block' : 'none';
      for (let i = 0; i < MAX_CUTS; i++) { const t = document.getElementById('tab-' + i); if (t) { t.classList.toggle('active', i === currentCutIndex); t.classList.toggle('has-cut', cutPoints[i].length === 3); } }
    }
    window.switchCutTab = (idx) => { currentCutIndex = idx; updateUI(); };
    window.flipCurrentCut = () => { planes[currentCutIndex].normal.negate(); planes[currentCutIndex].constant *= -1; calculateIntersectionPointsAndCreateCap(planes[currentCutIndex], currentCutIndex); };
    window.resetAll = () => { cutPoints.forEach((_, i) => { cutPoints[i] = []; cutMarkers[i].forEach(m => scene.remove(m)); cutMarkers[i] = []; planes[i].setComponents(0, -1, 0, 10000); if (capMeshes[i]) scene.remove(capMeshes[i]); capMeshes[i] = null; }); setDivision(1); updateUI(); };
    function animate() { requestAnimationFrame(animate); controls.update(); renderer.render(scene, camera); }
    window.onload = init;
    window.addEventListener('resize', () => { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });
  </script>
</body>

</html>