let scene,camera,renderer,controls,planes=[],cutPoints=[],cutMarkers=[],capMeshes=[],planesFlipped=[],currentCutIndex=0;const MAX_CUTS=8;let currentMesh,wireMesh,currentGeo,currentEdgesGeo,snapGroup=new THREE.Group,markerGroup=new THREE.Group,openDropdown=null,curDiv=1,showWire=!0,snapMode=0,isDragging=!1,draggedMarker=null,draggedEdgeIds=[],dragStartIndex=-1,dragStartTime=0,dragStartPos=new THREE.Vector2;const CUT_COLORS=[16711680,32768,255,16747520,8388736,52945,16711935,1260427];function toggleDropdown(e){const t=document.getElementById(e);openDropdown&&openDropdown!==t&&openDropdown.classList.remove("open"),t.classList.toggle("open"),openDropdown=t.classList.contains("open")?t:null}function closeAll(){openDropdown&&(openDropdown.classList.remove("open"),openDropdown=null)}function setShapeUI(e){document.querySelectorAll("#panel-shape .grid-btn").forEach(e=>e.classList.remove("active")),setShape(e),document.getElementById("cube-params").classList.toggle("show","cube"===e),document.getElementById("box-params").classList.toggle("show","box"===e),"cube"!==e&&"box"!==e&&closeAll()}function setDivisionUI(e){curDiv=e,setDivision(e),closeAll()}function stepParam(e,t,n){const r=document.getElementById(e);let o=parseFloat(r.value)+t;o<1&&(o=1),"inp-cube-s"===e&&(o<2&&(o=2),o>12&&(o=12)),r.value=o,setShape(n)}function init(){scene=new THREE.Scene,scene.background=new THREE.Color(16645365),camera=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,.1,1e3),camera.position.set(20,20,26),renderer=new THREE.WebGLRenderer({antialias:!0}),renderer.setSize(window.innerWidth,window.innerHeight),renderer.localClippingEnabled=!0,document.body.appendChild(renderer.domElement),controls=new THREE.OrbitControls(camera,renderer.domElement),controls.enableDamping=!0,controls.target.set(0,0,0);const e=new THREE.AmbientLight(8421504);scene.add(e);const t=new THREE.DirectionalLight(16777215,.8);t.position.set(10,20,10),scene.add(t);for(let e=0;e<8;e++)planes.push(new THREE.Plane(new THREE.Vector3(0,-1,0),1e4)),cutPoints.push([]),cutMarkers.push([]),capMeshes.push(null),planesFlipped.push(!1);scene.add(snapGroup),scene.add(markerGroup),setShape("cube"),animate()}function setShape(e){let t,n;if(resetAllInternal(),currentMesh&&scene.remove(currentMesh,wireMesh),"cube"===e){const e=parseFloat(document.getElementById("inp-cube-s").value);t=new THREE.BoxGeometry(e,e,e),n=new THREE.EdgesGeometry(t)}else"box"===e?(t=new THREE.BoxGeometry(parseFloat(document.getElementById("inp-w").value),parseFloat(document.getElementById("inp-h").value),parseFloat(document.getElementById("inp-d").value)),n=new THREE.EdgesGeometry(t)):"sphere"===e?(t=new THREE.SphereGeometry(6,48,48),n=new THREE.EdgesGeometry(new THREE.SphereGeometry(6,12,10))):"prism-3"===e?(t=new THREE.CylinderGeometry(5,5,9,3),n=new THREE.EdgesGeometry(t)):"prism-5"===e?(t=new THREE.CylinderGeometry(5,5,9,5),n=new THREE.EdgesGeometry(t)):"prism-6"===e?(t=new THREE.CylinderGeometry(5,5,9,6),n=new THREE.EdgesGeometry(t)):"cylinder"===e?(t=new THREE.CylinderGeometry(4,4,9,32),n=new THREE.EdgesGeometry(new THREE.CylinderGeometry(4,4,9,12))):"pyramid-3"===e?(t=new THREE.ConeGeometry(6,9,3),n=new THREE.EdgesGeometry(t)):"pyramid-4"===e?(t=new THREE.ConeGeometry(6,9,4),n=new THREE.EdgesGeometry(t)):"pyramid-5"===e?(t=new THREE.ConeGeometry(6,9,5),n=new THREE.EdgesGeometry(t)):"pyramid-6"===e?(t=new THREE.ConeGeometry(6,9,6),n=new THREE.EdgesGeometry(t)):"cone"===e?(t=new THREE.ConeGeometry(6,9,32),n=new THREE.EdgesGeometry(new THREE.ConeGeometry(6,9,12))):"poly-4"===e?(t=new THREE.TetrahedronGeometry(6),n=new THREE.EdgesGeometry(t)):"poly-8"===e?(t=new THREE.OctahedronGeometry(6),n=new THREE.EdgesGeometry(t)):"poly-12"===e?(t=new THREE.DodecahedronGeometry(6),n=new THREE.EdgesGeometry(t)):"poly-20"===e?(t=new THREE.IcosahedronGeometry(6),n=new THREE.EdgesGeometry(t)):(t=new THREE.BoxGeometry(6,6,6),n=new THREE.EdgesGeometry(t));currentGeo=t,currentEdgesGeo=n,currentMesh=new THREE.Mesh(t,new THREE.MeshPhongMaterial({color:11064802,side:THREE.DoubleSide,clippingPlanes:planes,clipShadows:!0})),wireMesh=new THREE.LineSegments(n,new THREE.LineBasicMaterial({color:0,opacity:.3,transparent:!0})),scene.add(currentMesh,wireMesh),wireMesh.visible=showWire,setDivision(curDiv)}const isTouchDevice=()=>"ontouchstart"in window||navigator.maxTouchPoints>0;function setDivision(e){snapGroup.clear();const t=isTouchDevice()?.45:.2,n=new THREE.MeshBasicMaterial({color:5592405,opacity:.4,transparent:!0}),r=currentEdgesGeo?currentEdgesGeo.attributes.position:currentMesh.geometry.attributes.position,o={};for(let e=0;e<r.count;e++){const s=(new THREE.Vector3).fromBufferAttribute(r,e),a="ConeGeometry"===currentGeo.type&&Math.abs(s.y-4.5)<.01&&Math.abs(s.x-0)<.01,i="OctahedronGeometry"===currentGeo.type,c="SphereGeometry"===currentGeo.type;if(!a&&!i&&!c&&Math.abs(s.x-0)<.01&&Math.abs(s.z-0)<.01)continue;const d=`${s.x.toFixed(3)},${s.y.toFixed(3)},${s.z.toFixed(3)}`;if(!o[d]){const e=new THREE.Mesh(new THREE.SphereGeometry(t),n);e.position.copy(s),e.userData.edgeIds=[],o[d]=e,snapGroup.add(e)}}if(currentEdgesGeo){const r=currentEdgesGeo.attributes.position;for(let s=0;s<r.count;s+=2){const a=(new THREE.Vector3).fromBufferAttribute(r,s),i=(new THREE.Vector3).fromBufferAttribute(r,s+1),c=`${a.x.toFixed(3)},${a.y.toFixed(3)},${a.z.toFixed(3)}`,d=`${i.x.toFixed(3)},${i.y.toFixed(3)},${i.z.toFixed(3)}`,u=`e_${s}`;if(o[c]&&o[c].userData.edgeIds.push(u),o[d]&&o[d].userData.edgeIds.push(u),e>1)for(let r=1;r<e;r++){const o=new THREE.Mesh(new THREE.SphereGeometry(t),n);o.position.lerpVectors(a,i,r/e),o.userData.edgeIds=[u],snapGroup.add(o)}}}}function calculateIntersectionPointsAndCreateCap(e,t){const n=[],r=currentEdgesGeo.attributes.position;for(let t=0;t<r.count;t+=2){const o=(new THREE.Vector3).fromBufferAttribute(r,t),s=(new THREE.Vector3).fromBufferAttribute(r,t+1),a=new THREE.Line3(o,s),i=new THREE.Vector3;e.intersectLine(a,i)&&(n.some(e=>e.distanceTo(i)<.01)||n.push(i.clone()))}if(capMeshes[t]&&scene.remove(capMeshes[t]),n.length>=3){const r=new THREE.Vector3;n.forEach(e=>r.add(e)),r.divideScalar(n.length);const o=e.normal.clone();let s=new THREE.Vector3(0,1,0);Math.abs(o.dot(s))>.9&&s.set(1,0,0);const a=s.cross(o).normalize(),i=o.clone().cross(a).normalize();n.sort((e,t)=>Math.atan2(e.clone().sub(r).dot(i),e.clone().sub(r).dot(a))-Math.atan2(t.clone().sub(r).dot(i),t.clone().sub(r).dot(a)));const c=new THREE.Shape(n.map(e=>new THREE.Vector2(e.clone().sub(r).dot(a),e.clone().sub(r).dot(i)))),d=new THREE.Mesh(new THREE.ShapeGeometry(c),new THREE.MeshPhongMaterial({color:CUT_COLORS[t],side:THREE.DoubleSide,opacity:.6,transparent:!0,clippingPlanes:planes.filter((e,n)=>n!==t),polygonOffset:!0,polygonOffsetFactor:-1,polygonOffsetUnits:-1})),u=(new THREE.Matrix4).makeBasis(a,i,o);d.applyMatrix4(u),d.position.copy(r),capMeshes[t]=d,scene.add(d)}}const raycaster=new THREE.Raycaster,mouse=new THREE.Vector2;function findClosestObject(e,t,n=.6){const r=e.intersectObjects(t);if(r.length>0)return r[0].object;let o=null,s=n;const a=e.ray;for(const e of t){const t=a.distanceToPoint(e.position);t<s&&(s=t,o=e)}return o}function applyCut(){const e=cutPoints[currentCutIndex],t=(new THREE.Vector3).subVectors(e[1],e[0]),n=(new THREE.Vector3).subVectors(e[2],e[0]);(new THREE.Vector3).crossVectors(t,n).length()<1e-4?resetCurrentCut():(planes[currentCutIndex].setFromCoplanarPoints(e[0],e[1],e[2]),planesFlipped[currentCutIndex]&&(planes[currentCutIndex].normal.negate(),planes[currentCutIndex].constant*=-1),calculateIntersectionPointsAndCreateCap(planes[currentCutIndex],currentCutIndex),updateUI())}function updateUI(){const e=cutPoints[currentCutIndex].length;document.getElementById("status-box").innerText=`${e} / 3`,document.getElementById("btn-flip").style.display=3===e?"block":"none",document.getElementById("btn-reset-single").style.display=e>0?"block":"none";for(let e=0;e<8;e++){const t=document.getElementById("tab-"+e);t&&(t.classList.toggle("active",e===currentCutIndex),t.classList.toggle("has-cut",3===cutPoints[e].length))}}function resetAllInternal(){cutPoints.forEach((e,t)=>{currentCutIndex=t,resetCurrentCut()}),currentCutIndex=0,updateUI()}function animate(){requestAnimationFrame(animate),controls.update(),renderer.render(scene,camera)}isTouchDevice()&&(raycaster.params.Points.threshold=1.5),window.addEventListener("pointerdown",e=>{if(e.target.closest("#top-nav")||e.target.closest("#app-header"))return;mouse.x=e.clientX/window.innerWidth*2-1,mouse.y=-e.clientY/window.innerHeight*2+1,raycaster.setFromCamera(mouse,camera);const t=findClosestObject(raycaster,markerGroup.children,.8);if(t){const e=cutMarkers[currentCutIndex].indexOf(t);if(-1!==e)return isDragging=!0,draggedMarker=t,dragStartIndex=e,draggedEdgeIds=t.userData.edgeIds||[],dragStartTime=Date.now(),dragStartPos.copy(mouse),void(controls.enabled=!1)}const n=findClosestObject(raycaster,snapGroup.children,.6);if(n){const e=n.position.clone();if(cutPoints[currentCutIndex].length>=3)return;cutPoints[currentCutIndex].push(e);const t=isTouchDevice()?.5:.35,r=new THREE.Mesh(new THREE.SphereGeometry(t,12,10),new THREE.MeshBasicMaterial({color:CUT_COLORS[currentCutIndex]}));r.position.copy(e),r.userData.edgeIds=[...n.userData.edgeIds||[]],r.renderOrder=999,markerGroup.add(r),cutMarkers[currentCutIndex].push(r),updateUI(),3===cutPoints[currentCutIndex].length&&applyCut()}}),window.addEventListener("pointermove",e=>{if(!isDragging||!draggedMarker)return;mouse.x=e.clientX/window.innerWidth*2-1,mouse.y=-e.clientY/window.innerHeight*2+1,raycaster.setFromCamera(mouse,camera);const t=snapGroup.children.filter(e=>(e.userData.edgeIds||[]).some(e=>draggedEdgeIds.includes(e))),n=findClosestObject(raycaster,t,1.2);if(n){const e=n.position.clone();draggedMarker.position.copy(e),draggedMarker.userData.edgeIds=[...n.userData.edgeIds||[]],cutPoints[currentCutIndex][dragStartIndex].copy(e),3===cutPoints[currentCutIndex].length&&applyCut()}}),window.addEventListener("pointerup",e=>{if(isDragging){const e=Date.now()-dragStartTime,t=mouse.distanceTo(dragStartPos);e<300&&t<.05&&(markerGroup.remove(draggedMarker),cutMarkers[currentCutIndex].splice(dragStartIndex,1),cutPoints[currentCutIndex].splice(dragStartIndex,1),planes[currentCutIndex].setComponents(0,-1,0,1e4),capMeshes[currentCutIndex]&&(scene.remove(capMeshes[currentCutIndex]),capMeshes[currentCutIndex]=null),updateUI()),isDragging=!1,draggedMarker=null,draggedEdgeIds=[],dragStartIndex=-1,controls.enabled=!0}}),window.switchCutTab=e=>{currentCutIndex=e,updateUI()},window.flipCurrentCut=()=>{planesFlipped[currentCutIndex]=!planesFlipped[currentCutIndex],planes[currentCutIndex].normal.negate(),planes[currentCutIndex].constant*=-1,calculateIntersectionPointsAndCreateCap(planes[currentCutIndex],currentCutIndex)},window.resetCurrentCut=()=>{cutPoints[currentCutIndex]=[],cutMarkers[currentCutIndex].forEach(e=>markerGroup.remove(e)),cutMarkers[currentCutIndex]=[],planes[currentCutIndex].setComponents(0,-1,0,1e4),planesFlipped[currentCutIndex]=!1,capMeshes[currentCutIndex]&&scene.remove(capMeshes[currentCutIndex]),capMeshes[currentCutIndex]=null,updateUI()},window.toggleWireframe=()=>{showWire=!showWire,wireMesh&&(wireMesh.visible=showWire);const e=document.getElementById("btn-toggle-wire");e.innerText=showWire?"ðŸ•¸ï¸ è£œåŠ©ç·šï¼šON":"ðŸ•¸ï¸ è£œåŠ©ç·šï¼šOFF",e.classList.toggle("active",showWire)},window.toggleSnapPoints=()=>{snapMode=(snapMode+1)%3;const e=document.getElementById("btn-toggle-snap");0===snapMode?(snapGroup.visible=!0,markerGroup.visible=!0,e.innerText="âš« ç‚¹ï¼šå…¨è¡¨ç¤º",e.classList.add("active"),e.style.opacity="1"):1===snapMode?(snapGroup.visible=!1,markerGroup.visible=!0,e.innerText="âš« ç‚¹ï¼šé¸æŠžã®ã¿",e.classList.add("active"),e.style.opacity="1"):(snapGroup.visible=!1,markerGroup.visible=!1,e.innerText="âš« ç‚¹ï¼šå…¨éžè¡¨ç¤º",e.classList.remove("active"),e.style.opacity="0.7")},window.resetAll=()=>{resetAllInternal()},window.onload=()=>{init()},window.addEventListener("resize",()=>{camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix(),renderer.setSize(window.innerWidth,window.innerHeight)});